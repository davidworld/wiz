From: WizMime<support@wiz.cn>
Subject: =?gb2312?B?YTEwoaJIUmVnaW9uyc9jb21wYWN0wfezzLfWzvajqLb+o6k=?=
Date: Date: Fri, 23 Jul 2021 05:53:23 +0800
MIME-Version: 1.0
Content-Type: multipart/related;
	type="multipart/alternative";
	boundary="----=_Next_Part_0001049625.832"

This is a multi-part message in MIME format.

------=_Next_Part_0001049625.832
Content-Type: multipart/alternative;
	boundary="----=_Next_Part_0000349875.905"


------=_Next_Part_0000349875.905
Content-Type: text/plain;
	charset="gb2312"
Content-Transfer-Encoding: quoted-printable

This is a multi-part message in MIME format.

------=_Next_Part_0000349875.905
Content-Type: text/html;
	charset="gb2312"
Content-Transfer-Encoding: quoted-printable

<!DOCTYPE HTML><html><head>=0D=0A<meta http-equiv=3D"Content-Type=
" content=3D"text/html; charset=3Dgb2312">=0A=0A=0A=0A=0A=0A=0A=0A=
=0A=0A=0A=0A=0A<title>a10=A1=A2HRegion=C9=CFcompact=C1=F7=B3=CC=B7=
=D6=CE=F6=A3=A8=B6=FE=A3=A9</title>=0A    =0A<style id=3D"wiz_cus=
tom_css">html, .wiz-editor-body {font-size: 12pt;}.wiz-editor-bod=
y {font-family: Helvetica, 'Hiragino Sans GB', '=E5=BE=AE=E8=BD=AF=
=E9=9B=85=E9=BB=91', 'Microsoft YaHei UI', SimSun, SimHei, arial,=
 sans-serif;line-height: 1.7;margin: 0 auto;padding: 20px 16px;pa=
dding: 1.25rem 1rem;}.wiz-editor-body h1,.wiz-editor-body h2,.wiz=
-editor-body h3,.wiz-editor-body h4,.wiz-editor-body h5,.wiz-edit=
or-body h6 {margin:20px 0 10px;margin:1.25rem 0 0.625rem;padding:=
 0;font-weight: bold;}.wiz-editor-body h1 {font-size:20pt;font-si=
ze:1.67rem;}.wiz-editor-body h2 {font-size:18pt;font-size:1.5rem;=
}.wiz-editor-body h3 {font-size:15pt;font-size:1.25rem;}.wiz-edit=
or-body h4 {font-size:14pt;font-size:1.17rem;}.wiz-editor-body h5=
 {font-size:12pt;font-size:1rem;}.wiz-editor-body h6 {font-size:1=
2pt;font-size:1rem;color: #777777;margin: 1rem 0;}.wiz-editor-bod=
y div,.wiz-editor-body p,.wiz-editor-body ul,.wiz-editor-body ol,=
.wiz-editor-body dl,.wiz-editor-body li {margin:8px 0;}.wiz-edito=
r-body blockquote,.wiz-editor-body table,.wiz-editor-body pre,.wi=
z-editor-body code {margin:8px 0;}.wiz-editor-body .CodeMirror pr=
e {margin:0;}.wiz-editor-body ul,.wiz-editor-body ol {padding-lef=
t:32px;padding-left:2rem;}.wiz-editor-body ol.wiz-list-level1 > l=
i {list-style-type:decimal;}.wiz-editor-body ol.wiz-list-level2 >=
 li {list-style-type:lower-latin;}.wiz-editor-body ol.wiz-list-le=
vel3 > li {list-style-type:lower-roman;}.wiz-editor-body blockquo=
te {padding: 0 12px;}.wiz-editor-body blockquote > :first-child {=
margin-top:0;}.wiz-editor-body blockquote > :last-child {margin-b=
ottom:0;}.wiz-editor-body img {border:0;max-width:100%;height:aut=
o !important;margin:2px 0;}.wiz-editor-body table {border-collaps=
e:collapse;border:1px solid #bbbbbb;}.wiz-editor-body td,.wiz-edi=
tor-body th {padding:4px 8px;border-collapse:collapse;border:1px=20=
solid #bbbbbb;min-height:28px;word-break:break-word;box-sizing: b=
order-box;}.wiz-hide {display:none !important;}</style></head>=0A=
=0A<body class=3D"wiz-editor-body" spellcheck=3D"false" ><div><br=
></div><div><span>HBase=D4=B4=C2=EB=B7=D6=CE=F6=D6=AEHRegion=C9=CF=
compact=C1=F7=B3=CC=B7=D6=CE=F6=A3=A8=B6=FE=A3=A9</span><br><div>=
lipeng_bigdata 2016-03-03 21:38:04&nbsp; 3336&nbsp; =CA=D5=B2=D8=20=
1</div><div>=B7=D6=C0=E0=D7=A8=C0=B8=A3=BA HBase1.0.2=D4=B4=C2=EB=
=B7=D6=CE=F6</div><div>=B0=E6=C8=A8</div><div>&nbsp; &nbsp; &nbsp=
; &nbsp; =BC=CC=A1=B6HBase=D4=B4=C2=EB=B7=D6=CE=F6=D6=AEHRegion=C9=
=CFcompact=C1=F7=B3=CC=B7=D6=CE=F6=A3=A8=D2=BB=A3=A9=A1=B7=D2=BB=CE=
=C4=BA=F3=A3=AC=CE=D2=C3=C7=BC=CC=D0=F8HRegion=C9=CFcompact=C1=F7=
=B3=CC=B7=D6=CE=F6=A3=AC=BD=D3=CF=C2=C0=B4=D2=AA=BD=B2=B5=C4=CA=C7=
=D5=EB=B6=D4=B1=ED=D6=D0=C4=B3=B8=F6=C1=D0=B4=D8=CF=C2=CE=C4=BC=FE=
=B5=C4=BA=CF=B2=A2=A3=AC=BC=B4HStore=B5=C4compact()=B7=BD=B7=A8=A3=
=AC=B4=FA=C2=EB=C8=E7=CF=C2=A3=BA</div><br><div>/**</div><div>&nb=
sp;&nbsp; * Compact the StoreFiles.&nbsp; This method may take so=
me time, so the calling</div><div>&nbsp;&nbsp; * thread must be a=
ble to block for long periods.</div><div>&nbsp;&nbsp; * </div><di=
v>&nbsp;&nbsp; * =BA=CF=B2=A2=B4=E6=B4=A2=CE=C4=BC=FE=A1=A3=B8=C3=
=B7=BD=B7=A8=BF=C9=C4=DC=BB=A8=B7=D1=D2=BB=D0=A9=CA=B1=BC=E4=A3=AC=
</div><div>&nbsp;&nbsp; *</div><div>&nbsp;&nbsp; * &lt;p&gt;Durin=
g this time, the Store can work as usual, getting values from</di=
v><div>&nbsp;&nbsp; * StoreFiles and writing new StoreFiles from=20=
the memstore.</div><div>&nbsp;&nbsp; * =D4=DA=B4=CB=C6=DA=BC=E4=A3=
=ACStore=C8=D4=C4=DC=CF=F1=CD=F9=B3=A3=D2=BB=D1=F9=B9=A4=D7=F7=A3=
=AC=B4=D3StoreFiles=BB=F1=C8=A1=CA=FD=BE=DD=BA=CD=B4=D3memstore=D0=
=B4=C8=EB=D0=C2=B5=C4StoreFiles</div><div>&nbsp;&nbsp; *</div><di=
v>&nbsp;&nbsp; * Existing StoreFiles are not destroyed until the=20=
new compacted StoreFile is</div><div>&nbsp;&nbsp; * completely wr=
itten-out to disk.</div><div>&nbsp;&nbsp; *</div><div>&nbsp;&nbsp=
; * &lt;p&gt;The compactLock prevents multiple simultaneous compa=
ctions.</div><div>&nbsp;&nbsp; * The structureLock prevents us fr=
om interfering with other write operations.</div><div>&nbsp;&nbsp=
; *</div><div>&nbsp;&nbsp; * &lt;p&gt;We don't want to hold the s=
tructureLock for the whole time, as a compact()</div><div>&nbsp;&=
nbsp; * can be lengthy and we want to allow cache-flushes during=20=
this period.</div><div>&nbsp;&nbsp; *</div><div>&nbsp;&nbsp; * &l=
t;p&gt; Compaction event should be idempotent, since there is no=20=
IO Fencing for</div><div>&nbsp;&nbsp; * the region directory in h=
dfs. A region server might still try to complete the</div><div>&n=
bsp;&nbsp; * compaction after it lost the region. That is why the=
 following events are carefully</div><div>&nbsp;&nbsp; * ordered=20=
for a compaction:</div><div>&nbsp;&nbsp; *&nbsp; 1. Compaction wr=
ites new files under region/.tmp directory (compaction output)</d=
iv><div>&nbsp;&nbsp; *&nbsp; 2. Compaction atomically moves the t=
emporary file under region directory</div><div>&nbsp;&nbsp; *&nbs=
p; 3. Compaction appends a WAL edit containing the compaction inp=
ut and output files.</div><div>&nbsp;&nbsp; *&nbsp; Forces sync o=
n WAL.</div><div>&nbsp;&nbsp; *&nbsp; 4. Compaction deletes the i=
nput files from the region directory.</div><div>&nbsp;&nbsp; *</d=
iv><div>&nbsp;&nbsp; * Failure conditions are handled like this:<=
/div><div>&nbsp;&nbsp; *&nbsp; - If RS fails before 2, compaction=
 wont complete. Even if RS lives on and finishes</div><div>&nbsp;=
&nbsp; *&nbsp; the compaction later, it will only write the new d=
ata file to the region directory.</div><div>&nbsp;&nbsp; *&nbsp;=20=
Since we already have this data, this will be idempotent but we w=
ill have a redundant</div><div>&nbsp;&nbsp; *&nbsp; copy of the d=
ata.</div><div>&nbsp;&nbsp; *&nbsp; - If RS fails between 2 and 3=
, the region will have a redundant copy of the data. The</div><di=
v>&nbsp;&nbsp; *&nbsp; RS that failed won't be able to finish sny=
c() for WAL because of lease recovery in WAL.</div><div>&nbsp;&nb=
sp; *&nbsp; - If RS fails after 3, the region region server who o=
pens the region will pick up the</div><div>&nbsp;&nbsp; *&nbsp; t=
he compaction marker from the WAL and replay it by removing the c=
ompaction input files.</div><div>&nbsp;&nbsp; *&nbsp; Failed RS c=
an also attempt to delete those files, but the operation will be=20=
idempotent</div><div>&nbsp;&nbsp; *</div><div>&nbsp;&nbsp; * See=20=
HBASE-2231 for details.</div><div>&nbsp;&nbsp; *</div><div>&nbsp;=
&nbsp; * @param compaction compaction details obtained from reque=
stCompaction()</div><div>&nbsp;&nbsp; * @throws IOException</div>=
<div>&nbsp;&nbsp; * @return Storefile we compacted into or null i=
f we failed or opted out early.</div><div>&nbsp;&nbsp; */</div><d=
iv>&nbsp; @Override</div><div>&nbsp; public List&lt;StoreFile&gt;=
 compact(CompactionContext compaction) throws IOException {</div>=
<div>&nbsp; &nbsp; assert compaction !=3D null;</div><div>&nbsp;=20=
&nbsp; List&lt;StoreFile&gt; sfs =3D null;</div><div>&nbsp; &nbsp=
; </div><div>&nbsp; &nbsp; // =B4=D3=BA=CF=B2=A2=C9=CF=CF=C2=CE=C4=
CompactionContext=D6=D0=BB=F1=B5=C3=BA=CF=B2=A2=C7=EB=C7=F3Compac=
tionRequest=A3=AC=BC=B4cr</div><div>&nbsp; &nbsp; CompactionReque=
st cr =3D compaction.getRequest();;</div><div>&nbsp; &nbsp; </div=
><div>&nbsp; &nbsp; try {</div><div>&nbsp; &nbsp; &nbsp; // Do al=
l sanity checking in here if we have a valid CompactionRequest</d=
iv><div>&nbsp; &nbsp; &nbsp; // because we need to clean up after=
 it on the way out in a finally</div><div>&nbsp; &nbsp; &nbsp; //=
 block below</div><div>&nbsp; &nbsp; &nbsp; // </div><div>&nbsp;=20=
&nbsp; </div><div>&nbsp; &nbsp; &nbsp; // =BB=F1=C8=A1compact=BF=AA=
=CA=BC=CA=B1=BC=E4compactionStartTime</div><div>&nbsp; &nbsp; &nb=
sp; long compactionStartTime =3D EnvironmentEdgeManager.currentTi=
me();</div><div>&nbsp; &nbsp; &nbsp; </div><div>&nbsp; &nbsp; &nb=
sp; // =C8=B7=B1=A3=BA=CF=B2=A2=C7=EB=C7=F3request=B2=BB=CE=AA=BF=
=D5=A3=AC=CA=B5=BC=CA=C9=CFgetRequest=D2=D1=BE=AD=C5=D0=B6=CF=B2=A2=
=C8=B7=B1=A3request=B2=BB=CE=AA=BF=D5=C1=CB=A3=AC=D5=E2=C0=EF=CE=AA=
=CA=B2=C3=B4=BB=B9=D2=AA=D4=D9=D7=F6=C5=D0=B6=CF=BA=CD=B1=A3=D6=A4=
=C4=D8=A3=BF=CF=C8=C1=F4=B8=F6=D0=A1=D0=A1=B5=C4=D2=C9=CE=CA=B0=C9=
=A3=A1</div><div>&nbsp; &nbsp; &nbsp; assert compaction.hasSelect=
ion();</div><div>&nbsp; &nbsp; &nbsp; </div><div>&nbsp; &nbsp; &n=
bsp; // =B4=D3=BA=CF=B2=A2=C7=EB=C7=F3cr=D6=D0=BB=F1=B5=C3=D0=E8=D2=
=AA=BA=CF=B2=A2=B5=C4=CE=C4=BC=FE=BC=AF=BA=CFfilesToCompact=A3=AC=
=BC=AF=BA=CF=D6=D0=B4=E6=B4=A2=B5=C4=B6=BC=CA=C7=B4=E6=B4=A2=CE=C4=
=BC=FEStoreFile=B5=C4=CA=B5=C0=FD</div><div>&nbsp; &nbsp; &nbsp;=20=
// =D5=E2=B8=F6=CE=C4=BC=FE=BC=AF=BA=CF=CA=C7=D4=DA=B9=B9=D4=ECCo=
mpactionRequest=C7=EB=C7=F3=A3=AC=BB=F2=D5=DF=BA=CF=B2=A2=C6=E4=CB=
=FB=C7=EB=C7=F3=CA=B1=A3=AC=B8=F9=BE=DD=B4=AB=C8=EB=B5=C4=B2=CE=CA=
=FD=BB=F2=D5=DF=C6=E4=CB=FB=C7=EB=C7=F3=D6=D0=B8=BD=B4=F8=B5=C4=CE=
=C4=BC=FE=BC=AF=BA=CF=C0=B4=C8=B7=B6=A8=B5=C4=A3=AC</div><div>&nb=
sp; &nbsp; &nbsp; // =BC=B4=C7=EB=C7=F3=D2=BB=B5=A9=C9=FA=B3=C9=A3=
=AC=D0=E8=D2=AA=BA=CF=B2=A2=B5=C4=CE=C4=BC=FE=BC=AF=BA=CFfilesToC=
ompact=BE=CD=BB=E1=B4=E6=D4=DA</div><div>&nbsp; &nbsp; &nbsp; Col=
lection&lt;StoreFile&gt; filesToCompact =3D cr.getFiles();</div><=
div>&nbsp; &nbsp; &nbsp; </div><div>&nbsp; &nbsp; &nbsp; // =C8=B7=
=B1=A3=D0=E8=D2=AA=BA=CF=B2=A2=B5=C4=CE=C4=BC=FE=BC=AF=BA=CFfiles=
ToCompact=B2=BB=CE=AA=BF=D5</div><div>&nbsp; &nbsp; &nbsp; assert=
 !filesToCompact.isEmpty();</div><div>&nbsp; &nbsp; &nbsp; </div>=
<div>&nbsp; &nbsp; &nbsp; // =C8=B7=B1=A3filesCompacting=D6=D0=B0=
=FC=BA=AC=CB=F9=D3=D0=B5=C4=B4=FD=BA=CF=B2=A2=CE=C4=BC=FEfilesToC=
ompact</div><div>&nbsp; &nbsp; &nbsp; synchronized (filesCompacti=
ng) {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; // sanity check: we'r=
e compacting files that this store knows about</div><div>&nbsp; &=
nbsp; &nbsp; &nbsp; // TODO: change this to LOG.error() after mor=
e debugging</div><div>&nbsp; &nbsp; &nbsp; &nbsp; Preconditions.c=
heckArgument(filesCompacting.containsAll(filesToCompact));</div><=
div>&nbsp; &nbsp; &nbsp; }</div><div>&nbsp;</div><div>&nbsp; &nbs=
p; &nbsp; // Ready to go. Have list of files to compact.</div><di=
v>&nbsp; &nbsp; &nbsp; LOG.info("Starting compaction of " + files=
ToCompact.size() + " file(s) in "</div><div>&nbsp; &nbsp; &nbsp;=20=
&nbsp; &nbsp; + this + " of " + this.getRegionInfo().getRegionNam=
eAsString()</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + " into=
 tmpdir=3D" + fs.getTempDir() + ", totalSize=3D"</div><div>&nbsp;=
 &nbsp; &nbsp; &nbsp; &nbsp; + StringUtils.humanReadableInt(cr.ge=
tSize()));</div><div>&nbsp;</div><div>&nbsp; &nbsp; &nbsp; // Com=
mence the compaction.</div><div>&nbsp; &nbsp; &nbsp; // =BF=AA=CA=
=BC=BA=CF=B2=A2=A3=AC=B5=F7=D3=C3CompactionContext=B5=C4compact()=
=B7=BD=B7=A8=A3=AC=BB=F1=B5=C3=BA=CF=B2=A2=BA=F3=B5=C4=D0=C2=CE=C4=
=BC=FEnewFiles</div><div>&nbsp; &nbsp; &nbsp; List&lt;Path&gt; ne=
wFiles =3D compaction.compact();</div><div>&nbsp;</div><div>&nbsp=
; &nbsp; &nbsp; // TODO: get rid of this!</div><div>&nbsp; &nbsp;=
 &nbsp; // =B8=F9=BE=DD=B2=CE=CA=FDhbase.hstore.compaction.comple=
te=C8=B7=CA=B5=CA=C7=B7=F1=D2=AA=CD=EA=D5=FB=B5=C4=CD=EA=B3=C9com=
pact</div><div>&nbsp; &nbsp; &nbsp; // =D5=E2=C0=EF=D3=D0=D2=E2=CB=
=BC=A3=AC=D5=E2=C3=B4=B4=A6=C0=ED=D2=E2=CE=B6=D7=C5=A3=AC=D0=C2=BE=
=C9=CE=C4=BC=FE=CD=AC=CA=B1=B4=E6=D4=DA=A3=AC=D0=C2=CE=C4=BC=FE=C3=
=BB=D3=D0=B1=BB=C5=B2=B5=BD=D6=B8=B6=A8=CE=BB=D6=C3=C7=D2=D0=C2=CE=
=C4=BC=FE=B5=C4Reader=B1=BB=B9=D8=B1=D5=A3=AC=B6=D4=CD=E2=CC=E1=B9=
=A9=B7=FE=CE=F1=B5=C4=BB=B9=CA=C7=BE=C9=CE=C4=BC=FE=A3=AC=C9=B6=C4=
=BF=B5=C4=C4=D8=A3=BF=BF=EC=CB=D9=D3=A6=D3=C3=D3=DA=B6=C1=A3=BF</=
div><div>&nbsp; &nbsp; &nbsp; if (!this.conf.getBoolean("hbase.hs=
tore.compaction.complete", true)) {</div><div>&nbsp; &nbsp; &nbsp=
; &nbsp; LOG.warn("hbase.hstore.compaction.complete is set to fal=
se");</div><div>&nbsp; &nbsp; &nbsp; &nbsp; </div><div>&nbsp; &nb=
sp; &nbsp; &nbsp; // =B4=B4=BD=A8StoreFile=C1=D0=B1=EDsfs=A3=AC=B4=
=F3=D0=A1=CE=AAnewFiles=B5=C4=B4=F3=D0=A1</div><div>&nbsp; &nbsp;=
 &nbsp; &nbsp; sfs =3D new ArrayList&lt;StoreFile&gt;(newFiles.si=
ze());</div><div>&nbsp; &nbsp; &nbsp; &nbsp; </div><div>&nbsp; &n=
bsp; &nbsp; &nbsp; // =B1=E9=C0=FA=D0=C2=B2=FA=C9=FA=B5=C4=BA=CF=B2=
=A2=BA=F3=B5=C4=CE=C4=BC=FEnewFiles=A3=AC=D5=EB=B6=D4=C3=BF=B8=F6=
=CE=C4=BC=FE=B4=B4=BD=A8StoreFile=BA=CDReader=A3=AC=B9=D8=B1=D5St=
oreFile=C9=CF=B5=C4Reader=A3=AC</div><div>&nbsp; &nbsp; &nbsp; &n=
bsp; // =B2=A2=BD=AB=B4=B4=BD=A8=B5=C4StoreFile=CC=ED=BC=D3=D6=C1=
=C1=D0=B1=EDsfs</div><div>&nbsp; &nbsp; &nbsp; &nbsp; for (Path n=
ewFile : newFiles) {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=
 // Create storefile around what we wrote with a reader on it.</d=
iv><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; StoreFile sf =3D creat=
eStoreFileAndReader(newFile);</div><div>&nbsp; &nbsp; &nbsp; &nbs=
p; &nbsp; </div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // =B9=D8=
=B1=D5=C6=E4=C9=CF=B5=C4Reader</div><div>&nbsp; &nbsp; &nbsp; &nb=
sp; &nbsp; sf.closeReader(true);</div><div>&nbsp; &nbsp; &nbsp; &=
nbsp; &nbsp; sfs.add(sf);</div><div>&nbsp; &nbsp; &nbsp; &nbsp; }=
</div><div>&nbsp; &nbsp; &nbsp; &nbsp; </div><div>&nbsp; &nbsp; &=
nbsp; &nbsp; // =B7=B5=BB=D8=BA=CF=B2=A2=BA=F3=B5=C4=CE=C4=BC=FE<=
/div><div>&nbsp; &nbsp; &nbsp; &nbsp; return sfs;</div><div>&nbsp=
; &nbsp; &nbsp; }</div><div>&nbsp; &nbsp; &nbsp; </div><div>&nbsp=
; &nbsp; &nbsp; // Do the steps necessary to complete the compact=
ion.</div><div>&nbsp; &nbsp; &nbsp; // =D6=B4=D0=D0=B1=D8=D2=AA=B5=
=C4=B2=BD=D6=E8=D2=D4=CD=EA=B3=C9=D5=E2=B8=F6=BA=CF=B2=A2</div><d=
iv>&nbsp; &nbsp; &nbsp; </div><div>&nbsp; &nbsp; &nbsp; // =D2=C6=
=B6=AF=D2=D1=CD=EA=B3=C9=CE=C4=BC=FE=D6=C1=D5=FD=C8=B7=B5=C4=B5=D8=
=B7=BD=A3=AC=B4=B4=BD=A8StoreFile=BA=CDReader=A3=AC=B7=B5=BB=D8St=
oreFile=C1=D0=B1=EDsfs</div><div>&nbsp; &nbsp; &nbsp; sfs =3D mov=
eCompatedFilesIntoPlace(cr, newFiles);</div><div>&nbsp; &nbsp; &n=
bsp; </div><div>&nbsp; &nbsp; &nbsp; // =D4=DAWAL=D6=D0=D0=B4=C8=EB=
Compaction=BC=C7=C2=BC</div><div>&nbsp; &nbsp; &nbsp; writeCompac=
tionWalRecord(filesToCompact, sfs);</div><div>&nbsp; &nbsp; &nbsp=
; </div><div>&nbsp; &nbsp; &nbsp; // =CC=E6=BB=BBStoreFiles=A3=BA=
</div><div>&nbsp; &nbsp; &nbsp; // 1=A1=A2=C8=A5=B3=FD=B5=F4=CB=F9=
=D3=D0=B5=C4=BA=CF=B2=A2=C7=B0=A3=AC=BC=B4=D2=D1=B1=BB=BA=CF=B2=A2=
=B5=C4=CE=C4=BC=FEcompactedFiles=A3=AC=BD=AB=BA=CF=B2=A2=BA=F3=B5=
=C4=CE=C4=BC=FEsfs=BC=D3=C8=EB=B5=BDStoreFileManager=B5=C4storefi=
les=D6=D0=C8=A5=A3=AC</div><div>&nbsp; &nbsp; &nbsp; // storefile=
s=CE=AAStore=D6=D0=C4=BF=C7=B0=C8=AB=B2=BF=CC=E1=B9=A9=B7=FE=CE=F1=
=B5=C4=B4=E6=B4=A2=CE=C4=BC=FE=C1=D0=B1=ED=A3=BB</div><div>&nbsp;=
 &nbsp; &nbsp; // 2=A1=A2=D5=FD=D4=DA=BA=CF=B2=A2=B5=C4=CE=C4=BC=FE=
=C1=D0=B1=EDfilesCompacting=D6=D0=C8=A5=B3=FD=B1=BB=BA=CF=B2=A2=B5=
=C4=CE=C4=BC=FEfilesToCompact=A3=BB</div><div>&nbsp; &nbsp; &nbsp=
; replaceStoreFiles(filesToCompact, sfs);</div><div>&nbsp; &nbsp;=
 &nbsp; </div><div>&nbsp; &nbsp; &nbsp; </div><div>&nbsp; &nbsp;=20=
&nbsp; // =B8=F9=BE=DD=BA=CF=B2=A2=B5=C4=C0=E0=D0=CD=A3=AC=D5=EB=B6=
=D4=B2=BB=CD=AC=B5=C4=BC=C6=CA=FD=C6=F7=D7=F6=C0=DB=BC=D3=A3=AC=B7=
=BD=B1=E3=CF=B5=CD=B3=D0=D4=C4=DC=D6=B8=B1=EA=BC=E0=BF=D8</div><d=
iv>&nbsp; &nbsp; &nbsp; if (cr.isMajor()) {// =C8=E7=B9=FB=CA=C7M=
ajor=BA=CF=B2=A2</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </d=
iv><div>&nbsp; &nbsp; &nbsp; &nbsp; // =BC=C6=CA=FD=C6=F7=C0=DB=BC=
=D3=A3=AC=B0=FC=C0=A8=CC=F5=CA=FD=BA=CD=B4=F3=D0=A1</div><div>&nb=
sp; &nbsp; &nbsp; &nbsp; majorCompactedCellsCount +=3D getCompact=
ionProgress().totalCompactingKVs;</div><div>&nbsp; &nbsp; &nbsp;=20=
&nbsp; majorCompactedCellsSize +=3D getCompactionProgress().total=
CompactedSize;</div><div>&nbsp; &nbsp; &nbsp; } else {// =C8=E7=B9=
=FB=B2=BB=CA=C7Major=BA=CF=B2=A2</div><div>&nbsp; &nbsp; &nbsp; &=
nbsp; &nbsp; </div><div>&nbsp; &nbsp; &nbsp; &nbsp; // =BC=C6=CA=FD=
=C6=F7=C0=DB=BC=D3=A3=AC=B0=FC=C0=A8=CC=F5=CA=FD=BA=CD=B4=F3=D0=A1=
</div><div>&nbsp; &nbsp; &nbsp; &nbsp; compactedCellsCount +=3D g=
etCompactionProgress().totalCompactingKVs;</div><div>&nbsp; &nbsp=
; &nbsp; &nbsp; compactedCellsSize +=3D getCompactionProgress().t=
otalCompactedSize;</div><div>&nbsp; &nbsp; &nbsp; }</div><div>&nb=
sp; &nbsp; &nbsp; </div><div>&nbsp; &nbsp; &nbsp; // At this poin=
t the store will use new files for all new scanners.</div><div>&n=
bsp; &nbsp; &nbsp; // =D6=C1=B4=CB=A3=ACstore=BD=AB=BB=E1=CE=AA=CB=
=F9=D3=D0=D0=C2=B5=C4scanners=CA=B9=D3=C3=D0=C2=B5=C4=CE=C4=BC=FE=
</div><div>&nbsp; &nbsp; &nbsp; // =CD=EA=B3=C9=BA=CF=B2=A2=A3=BA=
=B9=E9=B5=B5=BE=C9=CE=C4=BC=FE=A3=A8=D4=DA=CE=C4=BC=FE=CF=B5=CD=B3=
=D6=D0=C9=BE=B3=FD=D2=D1=B1=BB=BA=CF=B2=A2=B5=C4=CE=C4=BC=FEcompa=
ctedFiles=A3=AC=CA=B5=BC=CA=C9=CF=CA=C7=B9=E9=B5=B5=B2=D9=D7=F7=A3=
=AC=BD=AB=BE=C9=B5=C4=CE=C4=BC=FE=B4=D3=D4=AD=CE=BB=D6=C3=D2=C6=B5=
=BD=B9=E9=B5=B5=C4=BF=C2=BC=CF=C2=A3=A9=A3=AC=B9=D8=B1=D5=C6=E4=C9=
=CF=B5=C4Reader=A3=AC=B2=A2=B8=FC=D0=C2store=B4=F3=D0=A1</div><di=
v>&nbsp; &nbsp; &nbsp; completeCompaction(filesToCompact, true);=20=
// Archive old files &amp; update store size.</div><div>&nbsp;</d=
iv><div>&nbsp; &nbsp; &nbsp; // =BC=C7=C2=BC=C8=D5=D6=BE=D0=C5=CF=
=A2</div><div>&nbsp; &nbsp; &nbsp; logCompactionEndMessage(cr, sf=
s, compactionStartTime);</div><div>&nbsp; &nbsp; &nbsp; </div><di=
v>&nbsp; &nbsp; &nbsp; // =B7=B5=BB=D8StoreFile=C1=D0=B1=EDsfs</d=
iv><div>&nbsp; &nbsp; &nbsp; return sfs;</div><div>&nbsp; &nbsp;=20=
} finally {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; </div><div>&nbs=
p; &nbsp; &nbsp; // =CD=EA=B3=C9Compaction=C7=EB=C7=F3=A3=BARegio=
n=BB=E3=B1=A8=BA=CF=B2=A2=C7=EB=C7=F3=D6=C1=D6=D5=B6=CB=A1=A2file=
sCompacting=D6=D0=C9=BE=B3=FD=C7=EB=C7=F3=D6=D0=B5=C4=CB=F9=D3=D0=
=B4=FD=BA=CF=B2=A2=CE=C4=BC=FE</div><div>&nbsp; &nbsp; &nbsp; fin=
ishCompactionRequest(cr);</div><div>&nbsp; &nbsp; }</div><div>&nb=
sp; }</div><div>&nbsp; &nbsp; &nbsp; &nbsp; =CF=C2=C3=E6=A3=AC=CE=
=D2=C3=C7=C0=B4=B8=C5=CA=F6=CF=C2=D5=FB=B8=F6=C1=F7=B3=CC=A3=BA</=
div><div>&nbsp; &nbsp; &nbsp; &nbsp; 1=A1=A2=CA=D7=CF=C8=A3=AC=B4=
=D3=BA=CF=B2=A2=C9=CF=CF=C2=CE=C4CompactionContext=D6=D0=BB=F1=B5=
=C3=BA=CF=B2=A2=C7=EB=C7=F3CompactionRequest=A3=AC=BC=B4cr=A3=BB<=
/div><br><div>&nbsp; &nbsp; &nbsp; &nbsp; 2=A1=A2=BB=F1=C8=A1comp=
act=BF=AA=CA=BC=CA=B1=BC=E4compactionStartTime=A3=BB</div><br><di=
v>&nbsp; &nbsp; &nbsp; &nbsp; 3=A1=A2=C8=B7=B1=A3=BA=CF=B2=A2=C7=EB=
=C7=F3request=B2=BB=CE=AA=BF=D5=A3=BA</div><br><div>&nbsp; &nbsp;=
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; =CA=B5=BC=CA=C9=CFgetRequest=D2=
=D1=BE=AD=C5=D0=B6=CF=B2=A2=C8=B7=B1=A3request=B2=BB=CE=AA=BF=D5=C1=
=CB=A3=AC=D5=E2=C0=EF=CE=AA=CA=B2=C3=B4=BB=B9=D2=AA=D4=D9=D7=F6=C5=
=D0=B6=CF=BA=CD=B1=A3=D6=A4=C4=D8=A3=BF=CF=C8=C1=F4=B8=F6=D0=A1=D0=
=A1=B5=C4=D2=C9=CE=CA=B0=C9=A3=A1</div><br><div>&nbsp; &nbsp; &nb=
sp; &nbsp; 4=A1=A2=B4=D3=BA=CF=B2=A2=C7=EB=C7=F3cr=D6=D0=BB=F1=B5=
=C3=D0=E8=D2=AA=BA=CF=B2=A2=B5=C4=CE=C4=BC=FE=BC=AF=BA=CFfilesToC=
ompact=A3=BA</div><br><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nb=
sp; &nbsp; =BC=AF=BA=CF=D6=D0=B4=E6=B4=A2=B5=C4=B6=BC=CA=C7=B4=E6=
=B4=A2=CE=C4=BC=FEStoreFile=B5=C4=CA=B5=C0=FD=A3=AC=D5=E2=B8=F6=CE=
=C4=BC=FE=BC=AF=BA=CF=CA=C7=D4=DA=B9=B9=D4=ECCompactionRequest=C7=
=EB=C7=F3=A3=AC=BB=F2=D5=DF=BA=CF=B2=A2=C6=E4=CB=FB=C7=EB=C7=F3=CA=
=B1=A3=AC=B8=F9=BE=DD=B4=AB=C8=EB=B5=C4=B2=CE=CA=FD=BB=F2=D5=DF=C6=
=E4=CB=FB=C7=EB=C7=F3=D6=D0=B8=BD=B4=F8=B5=C4=CE=C4=BC=FE=BC=AF=BA=
=CF=C0=B4=C8=B7=B6=A8=B5=C4=A3=AC=BC=B4=C7=EB=C7=F3=D2=BB=B5=A9=C9=
=FA=B3=C9=A3=AC=D0=E8=D2=AA=BA=CF=B2=A2=B5=C4=CE=C4=BC=FE=BC=AF=BA=
=CFfilesToCompact=BE=CD=BB=E1=B4=E6=D4=DA=A1=A3</div><br><div>&nb=
sp; &nbsp; &nbsp; &nbsp; 5=A1=A2=C8=B7=B1=A3=D0=E8=D2=AA=BA=CF=B2=
=A2=B5=C4=CE=C4=BC=FE=BC=AF=BA=CFfilesToCompact=B2=BB=CE=AA=BF=D5=
=A3=BB</div><br><div>&nbsp; &nbsp; &nbsp; &nbsp; 6=A1=A2=C8=B7=B1=
=A3filesCompacting=D6=D0=B0=FC=BA=AC=CB=F9=D3=D0=B5=C4=B4=FD=BA=CF=
=B2=A2=CE=C4=BC=FEfilesToCompact=A3=BA</div><br><div>&nbsp; &nbsp=
; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; =C4=C7=C3=B4=D5=E2=B8=F6file=
sCompacting=D6=D0=B5=C4=CE=C4=BC=FE=CA=C7=BA=CE=CA=B1=CC=ED=BC=D3=
=B5=C4=C4=D8=A3=BF</div><br><div>&nbsp; &nbsp; &nbsp; &nbsp; 7=A1=
=A2=BF=AA=CA=BC=BA=CF=B2=A2=A3=AC=B5=F7=D3=C3CompactionContext=B5=
=C4compact()=B7=BD=B7=A8=A3=AC=BB=F1=B5=C3=BA=CF=B2=A2=BA=F3=B5=C4=
=D0=C2=CE=C4=BC=FEnewFiles=A3=BA</div><br><div>&nbsp; &nbsp; &nbs=
p; &nbsp; &nbsp; &nbsp; &nbsp; =D5=E2=D2=BB=B2=BD=CA=C7=BA=CB=D0=C4=
=C1=F7=B3=CC=A3=AC=CB=FC=BB=E1=B3=D6=D3=D0=CD=A8=B9=FDscanner=B7=C3=
=CE=CA=B4=FD=BA=CF=B2=A2=CE=C4=BC=FE=A3=AC=C8=BB=BA=F3=BD=AB=CA=FD=
=BE=DD=C8=AB=B2=BF=D0=B4=C8=EB=D0=C2=CE=C4=BC=FE=A3=AC=BA=F3=D0=F8=
=CE=C4=D5=C2=BB=E1=D7=C5=D6=D8=B7=D6=CE=F6=A1=A3</div><br><div>&n=
bsp; &nbsp; &nbsp; &nbsp; 8=A1=A2=B8=F9=BE=DD=B2=CE=CA=FDhbase.hs=
tore.compaction.complete=C8=B7=CA=B5=CA=C7=B7=F1=D2=AA=CD=EA=D5=FB=
=B5=C4=CD=EA=B3=C9compact=A3=AC=C4=AC=C8=CF=CE=AAtrue=A3=BA</div>=
<br><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 8=
.1=A1=A2=C8=E7=B9=FB=C5=E4=D6=C3=B5=C4=CA=C7false=A3=AC=D4=F2=A3=BA=
</div><br><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &=
nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8.1.1=A1=A2=B4=B4=BD=A8StoreFil=
e=C1=D0=B1=EDsfs=A3=AC=B4=F3=D0=A1=CE=AAnewFiles=B5=C4=B4=F3=D0=A1=
=A3=BB</div><br><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &n=
bsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8.1.2=A1=A2=B1=E9=C0=FA=D0=
=C2=B2=FA=C9=FA=B5=C4=BA=CF=B2=A2=BA=F3=B5=C4=CE=C4=BC=FEnewFiles=
=A3=AC=D5=EB=B6=D4=C3=BF=B8=F6=CE=C4=BC=FE=B4=B4=BD=A8StoreFile=BA=
=CDReader=A3=AC=B9=D8=B1=D5StoreFile=C9=CF=B5=C4Reader=A3=AC=B2=A2=
=BD=AB=B4=B4=BD=A8=B5=C4StoreFile=CC=ED=BC=D3=D6=C1=C1=D0=B1=EDsf=
s=A3=BB</div><br><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &=
nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8.1.3=A1=A2=B7=B5=BB=D8=BA=
=CF=B2=A2=BA=F3=B5=C4=CE=C4=BC=FE=C1=D0=B1=EDsfs=A3=BB</div><br><=
div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 8.2=A1=
=A2=C8=E7=B9=FB=C5=E4=D6=C3=B5=C4=CA=C7true=A3=AC=D4=F2=A3=BA</di=
v><br><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp=
; &nbsp; &nbsp; &nbsp; &nbsp; 8.2.1=A1=A2=D2=C6=B6=AF=D2=D1=CD=EA=
=B3=C9=CE=C4=BC=FE=D6=C1=D5=FD=C8=B7=B5=C4=B5=D8=B7=BD=A3=AC=B4=B4=
=BD=A8StoreFile=BA=CDReader=A3=AC=B7=B5=BB=D8StoreFile=C1=D0=B1=ED=
sfs=A3=BB</div><br><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8.2.2=A1=A2=D4=DAWAL=D6=
=D0=D0=B4=C8=EBCompaction=BC=C7=C2=BC=A3=BB</div><br><div>&nbsp;=20=
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &n=
bsp; &nbsp; 8.2.3=A1=A2=CC=E6=BB=BBStoreFiles=A3=BA=B0=FC=C0=A8=C8=
=A5=B3=FD=B5=F4=CB=F9=D3=D0=B5=C4=BA=CF=B2=A2=C7=B0=A3=AC=BC=B4=D2=
=D1=B1=BB=BA=CF=B2=A2=B5=C4=CE=C4=BC=FEcompactedFiles=A3=AC=BD=AB=
=BA=CF=B2=A2=BA=F3=B5=C4=CE=C4=BC=FEsfs=BC=D3=C8=EB=B5=BDStoreFil=
eManager=B5=C4storefiles=D6=D0=C8=A5=A3=ACstorefiles=CE=AAStore=D6=
=D0=C4=BF=C7=B0=C8=AB=B2=BF=CC=E1=B9=A9=B7=FE=CE=F1=B5=C4=B4=E6=B4=
=A2=CE=C4=BC=FE=C1=D0=B1=ED=A3=AC=BB=B9=D3=D0=D5=FD=D4=DA=BA=CF=B2=
=A2=B5=C4=CE=C4=BC=FE=C1=D0=B1=EDfilesCompacting=D6=D0=C8=A5=B3=FD=
=B1=BB=BA=CF=B2=A2=B5=C4=CE=C4=BC=FEfilesToCompact=A1=A3</div><br=
><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nb=
sp; &nbsp; &nbsp; &nbsp; 8.2.4=A1=A2=B8=F9=BE=DD=BA=CF=B2=A2=B5=C4=
=C0=E0=D0=CD=A3=AC=D5=EB=B6=D4=B2=BB=CD=AC=B5=C4=BC=C6=CA=FD=C6=F7=
=D7=F6=C0=DB=BC=D3=A3=AC=B7=BD=B1=E3=CF=B5=CD=B3=D0=D4=C4=DC=D6=B8=
=B1=EA=BC=E0=BF=D8=A3=BB</div><br><div>&nbsp; &nbsp; &nbsp; &nbsp=
; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8.2.5=A1=
=A2=CD=EA=B3=C9=BA=CF=B2=A2=A3=BA=B9=E9=B5=B5=BE=C9=CE=C4=BC=FE=A3=
=A8=D4=DA=CE=C4=BC=FE=CF=B5=CD=B3=D6=D0=C9=BE=B3=FD=D2=D1=B1=BB=BA=
=CF=B2=A2=B5=C4=CE=C4=BC=FEcompactedFiles=A3=AC=CA=B5=BC=CA=C9=CF=
=CA=C7=B9=E9=B5=B5=B2=D9=D7=F7=A3=AC=BD=AB=BE=C9=B5=C4=CE=C4=BC=FE=
=B4=D3=D4=AD=CE=BB=D6=C3=D2=C6=B5=BD=B9=E9=B5=B5=C4=BF=C2=BC=CF=C2=
=A3=A9=A3=AC=B9=D8=B1=D5=C6=E4=C9=CF=B5=C4Reader=A3=AC=B2=A2=B8=FC=
=D0=C2store=B4=F3=D0=A1=A3=BB</div><br><div>&nbsp; &nbsp; &nbsp;=20=
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8.=
2.6=A1=A2=BC=C7=C2=BC=C8=D5=D6=BE=D0=C5=CF=A2=A3=BB</div><br><div=
>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &=
nbsp; &nbsp; &nbsp; 8.2.7=A1=A2=CD=EA=B3=C9Compaction=C7=EB=C7=F3=
=A3=BARegion=BB=E3=B1=A8=BA=CF=B2=A2=C7=EB=C7=F3=D6=C1=D6=D5=B6=CB=
=A1=A2filesCompacting=D6=D0=C9=BE=B3=FD=C7=EB=C7=F3=D6=D0=B5=C4=CB=
=F9=D3=D0=B4=FD=BA=CF=B2=A2=CE=C4=BC=FE=A3=BB</div><br><div>&nbsp=
; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=20=
&nbsp; &nbsp; 8.2.8=A1=A2=B7=B5=BB=D8StoreFile=C1=D0=B1=EDsfs=A1=A3=
</div><br><div>&nbsp; &nbsp; &nbsp; &nbsp; =D6=C1=B4=CB=A3=AC=D5=FB=
=B8=F6=C1=F7=B3=CC=CF=EA=CA=F6=CD=EA=B1=CF=A1=A3=BD=D3=CF=C2=C0=B4=
=A3=AC=CE=D2=C3=C7=D5=EB=B6=D4=C6=E4=D6=D0=B5=C4=B2=BF=B7=D6=CF=B8=
=BD=DA=A3=AC=D4=D9=D7=F6=CF=EA=CF=B8=C3=E8=CA=F6=A1=A3</div><br><=
div>&nbsp; &nbsp; &nbsp; &nbsp; =CA=D7=CF=C8=A3=AC=D5=E6=D5=FD=D6=
=B4=D0=D0=BA=CF=B2=A2=B5=C4CompactionContext=B5=C4compact()=B7=BD=
=B7=A8=CE=D2=C3=C7=D4=DD=CA=B1=B2=BB=BD=B2=A3=AC=D6=BB=D0=E8=D2=AA=
=D6=AA=B5=C0=CB=FC=BB=E1=B3=D6=D3=D0=CD=A8=B9=FDscanner=B7=C3=CE=CA=
=B4=FD=BA=CF=B2=A2=CE=C4=BC=FE=A3=AC=C8=BB=BA=F3=BD=AB=CA=FD=BE=DD=
=C8=AB=B2=BF=D0=B4=C8=EB=D0=C2=CE=C4=BC=FE=A3=AC=B2=A2=B5=C3=B5=BD=
=D5=E2=D0=A9=D0=C2=CE=C4=BC=FE=B5=C4=BC=AF=BA=CFnewFiles=BC=B4=BF=
=C9=A3=AC=CE=D2=C3=C7=BB=E1=D4=DA=BA=F3=D0=F8=CE=C4=D5=C2=CF=EA=CF=
=B8=BD=E9=C9=DC=A1=A3</div><br><div>&nbsp; &nbsp; &nbsp; &nbsp; =BD=
=D3=CF=C2=C0=B4=A3=AC=D4=DA=BB=F1=B5=C3=BA=CF=B2=A2=BA=F3=B5=C4=D0=
=C2=CE=C4=BC=FEnewFiles=D6=AE=BA=F3=A3=AC=CE=D2=C3=C7=BB=E1=B8=F9=
=BE=DD=D2=BB=B8=F6=B2=CE=CA=FD=C0=B4=C8=B7=B6=A8=BA=F3=D0=F8=B4=A6=
=C0=ED=C1=F7=B3=CC=A3=AC=D5=E2=B8=F6=B2=CE=CA=FD=BE=CD=CA=C7hbase=
.hstore.compaction.complete=A3=AC=D3=C9=CB=FC=C0=B4=C8=B7=B6=A8=CA=
=C7=B7=F1=CD=EA=D5=FB=B5=C4=BD=E1=CA=F8=D2=BB=B4=CE=BA=CF=B2=A2=B2=
=D9=D7=F7=A3=AC=D5=E2=CD=EA=D5=FB=D3=EB=B7=C7=CD=EA=D5=FB=B5=C4=D6=
=F7=D2=AA=C7=F8=B1=F0=A3=AC=BB=F2=D5=DF=CB=B5=CA=B5=D6=CA=D0=D4=C7=
=F8=B1=F0=BE=CD=CA=C7=A3=BA=D3=C9=CB=AD=C0=B4=BC=CC=D0=F8=B6=D4=CD=
=E2=CC=E1=B9=A9=CA=FD=BE=DD=B6=C1=C8=A1=B7=FE=CE=F1=A1=A3</div><b=
r><div>&nbsp; &nbsp; &nbsp; &nbsp; =CF=C8=C0=B4=BF=B4=CF=C2=B7=C7=
=CD=EA=D5=FB=D0=D4=BD=E1=CA=F8=A3=AC=CB=FC=BB=E1=CE=AA=BA=CF=B2=A2=
=BA=F3=B5=C4=C3=BF=B8=F6=CE=C4=BC=FE=B4=B4=BD=A8StoreFile=BA=CDRe=
ader=CA=B5=C0=FD=A3=AC=CD=AC=CA=B1=B9=D8=B1=D5=D0=C2=CE=C4=BC=FE=C9=
=CF=B5=C4Reader=A3=AC=D2=B2=BE=CD=D2=E2=CE=B6=D7=C5=C8=D3=BC=CC=D0=
=F8=D3=C9=BE=C9=CE=C4=BC=FE=CC=E1=B9=A9=CA=FD=BE=DD=B6=C1=C8=A1=B7=
=FE=CE=F1=A3=AC=B6=F8=D0=C2=CE=C4=BC=FE=D3=EB=BE=C9=CE=C4=BC=FE=CD=
=AC=CA=B1=B4=E6=D4=DA=A3=AC=BE=C9=CE=C4=BC=FE=CE=BB=D6=C3=B2=BB=B1=
=E4=A3=AC=C9=E6=BC=B0=B5=BD=C1=D0=B4=D8CF=CF=C2=B5=C4=C4=BF=C7=B0=
=CB=F9=D3=D0=BF=C9=D3=C3storefiles=C1=D0=B1=ED=B2=BB=B1=E4=A3=AC=B4=
=E6=B4=A2=B5=C4=C8=D4=CA=C7=BE=C9=CE=C4=BC=FE=B5=C4StoreFile=B6=D4=
=CF=F3=A3=BB</div><br><div>&nbsp; &nbsp; &nbsp; &nbsp; =B6=F8=B6=D4=
=D3=DA=CD=EA=D5=FB=D0=D4=BD=E1=CA=F8=C0=B4=CB=B5=A3=AC=CB=FC=BB=E1=
=D2=C6=B6=AF=D2=D1=CD=EA=B3=C9=CE=C4=BC=FE=D6=C1=D5=FD=C8=B7=B5=C4=
=B5=D8=B7=BD=A3=AC=B4=B4=BD=A8StoreFile=BA=CDReader=A3=AC=B7=B5=BB=
=D8StoreFile=C1=D0=B1=EDsfs=A3=AC=C8=BB=BA=F3=D4=DAWAL=D6=D0=D0=B4=
=C8=EBCompaction=BC=C7=C2=BC=A3=AC=B2=A2=CC=E6=BB=BB=B5=F4storefi=
les=A3=AC=B8=F9=BE=DD=BA=CF=B2=A2=B5=C4=C0=E0=D0=CD=A3=AC=D5=EB=B6=
=D4=B2=BB=CD=AC=B5=C4=BC=C6=CA=FD=C6=F7=D7=F6=C0=DB=BC=D3=A3=AC=B7=
=BD=B1=E3=CF=B5=CD=B3=D0=D4=C4=DC=D6=B8=B1=EA=BC=E0=BF=D8=A3=AC=B9=
=E9=B5=B5=BE=C9=CE=C4=BC=FE=A3=A8=D4=DA=CE=C4=BC=FE=CF=B5=CD=B3=D6=
=D0=C9=BE=B3=FD=D2=D1=B1=BB=BA=CF=B2=A2=B5=C4=CE=C4=BC=FEcompacte=
dFiles=A3=AC=CA=B5=BC=CA=C9=CF=CA=C7=B9=E9=B5=B5=B2=D9=D7=F7=A3=AC=
=BD=AB=BE=C9=B5=C4=CE=C4=BC=FE=B4=D3=D4=AD=CE=BB=D6=C3=D2=C6=B5=BD=
=B9=E9=B5=B5=C4=BF=C2=BC=CF=C2=A3=A9=A3=AC=B9=D8=B1=D5=C6=E4=C9=CF=
=B5=C4Reader=A3=AC=B2=A2=B8=FC=D0=C2store=B4=F3=D0=A1=A3=AC=CD=EA=
=B3=C9Compaction=C7=EB=C7=F3=A3=BARegion=BB=E3=B1=A8=BA=CF=B2=A2=C7=
=EB=C7=F3=D6=C1=D6=D5=B6=CB=A1=A2filesCompacting=D6=D0=C9=BE=B3=FD=
=C7=EB=C7=F3=D6=D0=B5=C4=CB=F9=D3=D0=B4=FD=BA=CF=B2=A2=CE=C4=BC=FE=
=B5=C8=B5=C8=A3=AC=BA=DC=B6=E0=B8=B4=D4=D3=B5=C4=B2=D9=D7=F7=A1=A3=
=B2=BB=D2=AA=D7=C5=BC=B1=A3=AC=CE=D2=C3=C7=BE=CD=C6=E4=D6=D0=B8=B4=
=D4=D3=B5=C4=B5=D8=B7=BD=A3=AC=D2=BB=B8=F6=B8=F6=B5=C4=BD=E2=CA=CD=
=A3=BA</div><br><div>&nbsp; &nbsp; &nbsp; &nbsp; 1=A1=A2=D2=C6=B6=
=AF=D2=D1=CD=EA=B3=C9=CE=C4=BC=FE=D6=C1=D5=FD=C8=B7=B5=C4=B5=D8=B7=
=BD=A3=AC=B4=B4=BD=A8StoreFile=BA=CDReader=A3=AC=B7=B5=BB=D8Store=
File=C1=D0=B1=EDsfs</div><br><div>&nbsp; &nbsp; &nbsp; &nbsp; =D5=
=E2=B8=F6=CA=C7=CD=A8=B9=FDmoveCompatedFilesIntoPlace()=B7=BD=B7=A8=
=CA=B5=CF=D6=B5=C4=A3=AC=B4=FA=C2=EB=C8=E7=CF=C2=A3=BA</div><br><=
div>private List&lt;StoreFile&gt; moveCompatedFilesIntoPlace(</di=
v><div>&nbsp; &nbsp; &nbsp; CompactionRequest cr, List&lt;Path&gt=
; newFiles) throws IOException {</div><div>&nbsp; &nbsp; </div><d=
iv>&nbsp; &nbsp; // =B4=B4=BD=A8StoreFile=C1=D0=B1=EDsfs</div><di=
v>&nbsp; &nbsp; List&lt;StoreFile&gt; sfs =3D new ArrayList&lt;St=
oreFile&gt;(newFiles.size());</div><div>&nbsp; &nbsp; </div><div>=
&nbsp; &nbsp; // =B1=E9=C0=FAnewFiles</div><div>&nbsp; &nbsp; for=
 (Path newFile : newFiles) {</div><div>&nbsp; &nbsp; &nbsp; asser=
t newFile !=3D null;</div><div>&nbsp; &nbsp; &nbsp; </div><div>&n=
bsp; &nbsp; &nbsp; // =BD=AB=D0=C2=CE=C4=BC=FEnewFile=C5=B2=D6=C1=
=D5=FD=C8=B7=B5=D8=B5=E3=A3=AC=B2=A2=B4=B4=BD=A8StoreFile=BA=CDRe=
ader</div><div>&nbsp; &nbsp; &nbsp; StoreFile sf =3D moveFileInto=
Place(newFile);</div><div>&nbsp; &nbsp; &nbsp; if (this.getCoproc=
essorHost() !=3D null) {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; th=
is.getCoprocessorHost().postCompact(this, sf, cr);</div><div>&nbs=
p; &nbsp; &nbsp; }</div><div>&nbsp; &nbsp; &nbsp; assert sf !=3D=20=
null;</div><div>&nbsp; &nbsp; &nbsp; sfs.add(sf);</div><div>&nbsp=
; &nbsp; }</div><div>&nbsp; &nbsp; return sfs;</div><div>&nbsp; }=
</div><div>&nbsp; &nbsp; &nbsp; &nbsp; =CA=D7=CF=C8=C4=D8=A3=AC=B4=
=B4=BD=A8StoreFile=C1=D0=B1=EDsfs=A3=AC=B1=E9=C0=FA=BA=CF=B2=A2=BA=
=F3=B5=C4=CE=C4=BC=FEnewFiles=A3=AC=BD=AB=D0=C2=CE=C4=BC=FEnewFil=
e=C5=B2=D6=C1=D5=FD=C8=B7=B5=D8=B5=E3=A3=AC=B2=A2=B4=B4=BD=A8Stor=
eFile=BA=CDReader=A1=A3=B6=F8=CE=C4=BC=FE=CE=BB=D6=C3=B8=C4=B1=E4=
=A3=AC=D4=F2=CA=C7=CD=A8=B9=FDmoveFileIntoPlace()=B7=BD=B7=A8=CA=B5=
=CF=D6=B5=C4=A3=AC=CB=FC=B5=C4=B4=FA=C2=EB=C8=E7=CF=C2=A3=BA</div=
><div>// Package-visible for tests</div><div>&nbsp; StoreFile mov=
eFileIntoPlace(final Path newFile) throws IOException {</div><div=
>&nbsp; &nbsp; </div><div>&nbsp; &nbsp; // =BC=EC=B2=E2=D0=C2=CE=C4=
=BC=FE</div><div>&nbsp; &nbsp; validateStoreFile(newFile);</div><=
div>&nbsp; &nbsp; </div><div>&nbsp; &nbsp; // Move the file into=20=
the right spot</div><div>&nbsp; &nbsp; // =D2=C6=B6=AF=CE=C4=BC=FE=
=D6=C1=D5=FD=C8=B7=B5=C4=B5=D8=B5=E3</div><div>&nbsp; &nbsp; Path=
 destPath =3D fs.commitStoreFile(getColumnFamilyName(), newFile);=
</div><div>&nbsp; &nbsp; </div><div>&nbsp; &nbsp; // =B4=B4=BD=A8=
StoreFile=BA=CDReader</div><div>&nbsp; &nbsp; return createStoreF=
ileAndReader(destPath);</div><div>&nbsp; }</div><div>&nbsp; &nbsp=
; &nbsp; &nbsp; =CE=D2=C3=C7=B7=A2=CF=D6=A3=AC=D2=C6=B6=AF=CE=C4=BC=
=FE=CA=B5=BC=CA=C9=CF=CA=C7=CD=A8=B9=FDHStore=B5=C4=B3=C9=D4=B1=B1=
=E4=C1=BFfs=B5=C4commitStoreFile()=B7=BD=B7=A8=C0=B4=CD=EA=B3=C9=B5=
=C4=A1=A3=D5=E2=B8=F6fs=CA=C7HRegionFileSystem=C0=E0=D0=CD=B5=C4=B1=
=E4=C1=BF=A3=ACHRegionFileSystem=CA=C7HRegion=C9=CF=CE=C4=BC=FE=CF=
=B5=CD=B3=B5=C4=D2=BB=B8=F6=B3=E9=CF=F3=A3=AC=CB=FC=CA=B5=CF=D6=C1=
=CB=B8=F7=D6=D6=CE=C4=BC=FE=B5=C8=B5=C4=CA=B5=BC=CA=CE=EF=C0=ED=B2=
=D9=D7=F7=A1=A3=CE=D2=C3=C7=C0=B4=BF=B4=CF=C2=CB=FC=B5=C4commitSt=
oreFile()=B7=BD=B7=A8:</div><div>/**</div><div>&nbsp;&nbsp; * Mov=
e the file from a build/temp location to the main family store di=
rectory.</div><div>&nbsp;&nbsp; * @param familyName Family that w=
ill gain the file</div><div>&nbsp;&nbsp; * @param buildPath {@lin=
k Path} to the file to commit.</div><div>&nbsp;&nbsp; * @param se=
qNum Sequence Number to append to the file name (less then 0 if n=
o sequence number)</div><div>&nbsp;&nbsp; * @param generateNewNam=
e False if you want to keep the buildPath name</div><div>&nbsp;&n=
bsp; * @return The new {@link Path} of the committed file</div><d=
iv>&nbsp;&nbsp; * @throws IOException</div><div>&nbsp;&nbsp; */</=
div><div>&nbsp; private Path commitStoreFile(final String familyN=
ame, final Path buildPath,</div><div>&nbsp; &nbsp; &nbsp; final l=
ong seqNum, final boolean generateNewName) throws IOException {</=
div><div>&nbsp; &nbsp; </div><div>&nbsp; &nbsp; // =B8=F9=BE=DD=C1=
=D0=B4=D8=C3=FBfamilyName=BB=F1=C8=A1=B4=E6=B4=A2=C2=B7=BE=B6stor=
eDir</div><div>&nbsp; &nbsp; Path storeDir =3D getStoreDir(family=
Name);</div><div>&nbsp; &nbsp; </div><div>&nbsp; &nbsp; // =C8=E7=
=B9=FB=D4=DA=CE=C4=BC=FE=CF=B5=CD=B3fs=D6=D0=B2=BB=B4=E6=D4=DA=C2=
=B7=BE=B6=B5=C4=C7=E9=BF=F6=CF=C2=B4=B4=BD=A8=CB=FC=CA=B1=CA=A7=B0=
=DC=D4=F2=C5=D7=B3=F6=D2=EC=B3=A3</div><div>&nbsp; &nbsp; if(!fs.=
exists(storeDir) &amp;&amp; !createDir(storeDir))</div><div>&nbsp=
; &nbsp; &nbsp; throw new IOException("Failed creating " + storeD=
ir);</div><div>&nbsp;</div><div>&nbsp; &nbsp; String name =3D bui=
ldPath.getName();</div><div>&nbsp; &nbsp; if (generateNewName) {<=
/div><div>&nbsp; &nbsp; &nbsp; name =3D generateUniqueName((seqNu=
m &lt; 0) ? null : "_SeqId_" + seqNum + "_");</div><div>&nbsp; &n=
bsp; }</div><div>&nbsp; &nbsp; Path dstPath =3D new Path(storeDir=
, name);</div><div>&nbsp; &nbsp; if (!fs.exists(buildPath)) {</di=
v><div>&nbsp; &nbsp; &nbsp; throw new FileNotFoundException(build=
Path.toString());</div><div>&nbsp; &nbsp; }</div><div>&nbsp; &nbs=
p; LOG.debug("Committing store file " + buildPath + " as " + dstP=
ath);</div><div>&nbsp; &nbsp; // buildPath exists, therefore not=20=
doing an exists() check.</div><div>&nbsp; &nbsp; if (!rename(buil=
dPath, dstPath)) {</div><div>&nbsp; &nbsp; &nbsp; throw new IOExc=
eption("Failed rename of " + buildPath + " to " + dstPath);</div>=
<div>&nbsp; &nbsp; }</div><div>&nbsp; &nbsp; return dstPath;</div=
><div>&nbsp; }</div><div>&nbsp; &nbsp; &nbsp; &nbsp; =B7=C7=B3=A3=
=BC=F2=B5=A5=A3=AC=B8=F9=BE=DD=C1=D0=B4=D8=C3=FBfamilyName=BB=F1=C8=
=A1=B4=E6=B4=A2=C2=B7=BE=B6storeDir=A3=AC=BC=EC=B2=E2=B2=A2=D4=DA=
=B1=D8=D2=AA=CA=B1=B4=B4=BD=A8storeDir=A3=AC=B8=F9=BE=DDbuildPath=
=C0=B4=BB=F1=C8=A1=CE=C4=BC=FE=C3=FBname=A3=AC=C8=BB=BA=F3=C0=FB=D3=
=C3storeDir=BA=CDname=C0=B4=B9=B9=D4=EC=C4=BF=B1=EA=C2=B7=BE=B6st=
oreDir=A3=AC=CD=A8=B9=FDrename()=B7=BD=B7=A8=CA=B5=CF=D6=CE=C4=BC=
=FE=B4=D3buildPath=D6=C1dstPath=B5=C4=D2=C6=B6=AF=BC=B4=BF=C9=A1=A3=
</div><div>&nbsp; &nbsp; &nbsp; &nbsp; =B6=F8=B4=B4=BD=A8StoreFil=
e=BA=CDReader=B5=C4=B7=BD=B7=A8=D7=EE=D6=D5=B5=F7=D3=C3=B5=C4=CA=C7=
createStoreFileAndReader()=B7=BD=B7=A8=A3=AC=B4=FA=C2=EB=C8=E7=CF=
=C2=A3=BA</div><br><div>private StoreFile createStoreFileAndReade=
r(final StoreFileInfo info)</div><div>&nbsp; &nbsp; &nbsp; throws=
 IOException {</div><div>&nbsp; &nbsp; info.setRegionCoprocessorH=
ost(this.region.getCoprocessorHost());</div><div>&nbsp; &nbsp; St=
oreFile storeFile =3D new StoreFile(this.getFileSystem(), info, t=
his.conf, this.cacheConf,</div><div>&nbsp; &nbsp; &nbsp; this.fam=
ily.getBloomFilterType());</div><div>&nbsp; &nbsp; storeFile.crea=
teReader();</div><div>&nbsp; &nbsp; return storeFile;</div><div>&=
nbsp; }</div><div>&nbsp; &nbsp; &nbsp; &nbsp; StoreFile=CA=C7=D2=BB=
=B8=F6=B4=E6=B4=A2=CA=FD=BE=DD=CE=C4=BC=FE=A1=A3Stores=CD=A8=B3=A3=
=BA=AC=D3=D0=D2=BB=B8=F6=BB=F2=B6=E0=B8=F6StoreFile=A3=AC=B6=F8Re=
ader=CA=C7=C6=E4=C4=DA=B2=BF=C0=E0=A3=AC=D3=C9Reader=C0=B4=CC=E1=B9=
=A9=CE=C4=BC=FE=CA=FD=BE=DD=B5=C4=B6=C1=C8=A1=B7=FE=CE=F1=A1=A3</=
div><div>&nbsp; &nbsp; &nbsp; &nbsp; 2=A1=A2=D4=DAWAL=D6=D0=D0=B4=
=C8=EBCompaction=BC=C7=C2=BC</div><br><div>&nbsp; &nbsp; &nbsp; &=
nbsp; =D5=E2=B8=F6=B9=FD=B3=CC=CA=C7=CD=A8=B9=FDwriteCompactionWa=
lRecord()=B7=BD=B7=A8=C0=B4=CD=EA=B3=C9=B5=C4=A3=AC=B4=FA=C2=EB=C8=
=E7=CF=C2=A3=BA</div><br><div>/**</div><div>&nbsp;&nbsp; * Writes=
 the compaction WAL record.</div><div>&nbsp;&nbsp; * =D4=DAWAL=D6=
=D0=D0=B4=C8=EB=BA=CF=B2=A2=BC=C7=C2=BC</div><div>&nbsp;&nbsp; *=20=
</div><div>&nbsp;&nbsp; * @param filesCompacted Files compacted (=
input).</div><div>&nbsp;&nbsp; * @param newFiles Files from compa=
ction.</div><div>&nbsp;&nbsp; */</div><div>&nbsp; private void wr=
iteCompactionWalRecord(Collection&lt;StoreFile&gt; filesCompacted=
,</div><div>&nbsp; &nbsp; &nbsp; Collection&lt;StoreFile&gt; newF=
iles) throws IOException {</div><div>&nbsp; &nbsp; </div><div>&nb=
sp; &nbsp; // =C8=E7=B9=FBregion=D6=D0=B5=C4WAL=CE=AA=BF=D5=A3=AC=
=D4=F2=D6=B1=BD=D3=B7=B5=BB=D8&nbsp; </div><div>&nbsp; &nbsp; if=20=
(region.getWAL() =3D=3D null) return;</div><div>&nbsp; &nbsp; </d=
iv><div>&nbsp; &nbsp; // =BD=AB=B1=BB=BA=CF=B2=A2=B5=C4=CE=C4=BC=FE=
=C2=B7=BE=B6=CC=ED=BC=D3=D6=C1inputPaths=C1=D0=B1=ED</div><div>&n=
bsp; &nbsp; List&lt;Path&gt; inputPaths =3D new ArrayList&lt;Path=
&gt;(filesCompacted.size());</div><div>&nbsp; &nbsp; for (StoreFi=
le f : filesCompacted) {</div><div>&nbsp; &nbsp; &nbsp; inputPath=
s.add(f.getPath());</div><div>&nbsp; &nbsp; }</div><div>&nbsp; &n=
bsp; </div><div>&nbsp; &nbsp; // =BD=AB=BA=CF=B2=A2=BA=F3=B5=C4=CE=
=C4=BC=FE=C2=B7=BE=B6=CC=ED=BC=D3=D6=C1inputPaths=C1=D0=B1=ED</di=
v><div>&nbsp; &nbsp; List&lt;Path&gt; outputPaths =3D new ArrayLi=
st&lt;Path&gt;(newFiles.size());</div><div>&nbsp; &nbsp; for (Sto=
reFile f : newFiles) {</div><div>&nbsp; &nbsp; &nbsp; outputPaths=
.add(f.getPath());</div><div>&nbsp; &nbsp; }</div><div>&nbsp; &nb=
sp; </div><div>&nbsp; &nbsp; // =BB=F1=C8=A1HRegionInfo=A3=AC=BC=B4=
info</div><div>&nbsp; &nbsp; HRegionInfo info =3D this.region.get=
RegionInfo();</div><div>&nbsp; &nbsp; </div><div>&nbsp; &nbsp; //=
 =B9=B9=D4=ECcompaction=B5=C4=C3=E8=CA=F6=D0=C5=CF=A2CompactionDe=
scriptor</div><div>&nbsp; &nbsp; CompactionDescriptor compactionD=
escriptor =3D ProtobufUtil.toCompactionDescriptor(info,</div><div=
>&nbsp; &nbsp; &nbsp; &nbsp; family.getName(), inputPaths, output=
Paths, fs.getStoreDir(getFamily().getNameAsString()));</div><div>=
&nbsp; &nbsp; </div><div>&nbsp; &nbsp; // =C0=FB=D3=C3WALUtil=B9=A4=
=BE=DF=C0=E0=B5=C4writeCompactionMarker()=B7=BD=B7=A8=A3=AC=D4=DA=
WAL=D6=D0=D0=B4=C8=EB=D2=BB=B8=F6=BA=CF=B2=A2=B1=EA=BC=C7</div><d=
iv>&nbsp; &nbsp; WALUtil.writeCompactionMarker(region.getWAL(), t=
his.region.getTableDesc(),</div><div>&nbsp; &nbsp; &nbsp; &nbsp;=20=
this.region.getRegionInfo(), compactionDescriptor, this.region.ge=
tSequenceId());</div><div>&nbsp; }</div><div>&nbsp; &nbsp; &nbsp;=
 &nbsp; =C2=DF=BC=AD=B1=C8=BD=CF=BC=F2=B5=A5=A3=BA</div><div>&nbs=
p; &nbsp; &nbsp; &nbsp; 1=A1=A2=BD=AB=B1=BB=BA=CF=B2=A2=B5=C4=CE=C4=
=BC=FE=C2=B7=BE=B6=CC=ED=BC=D3=D6=C1inputPaths=C1=D0=B1=ED=A3=BB<=
/div><br><div>&nbsp; &nbsp; &nbsp; &nbsp; 2=A1=A2=BD=AB=BA=CF=B2=A2=
=BA=F3=B5=C4=CE=C4=BC=FE=C2=B7=BE=B6=CC=ED=BC=D3=D6=C1outputPaths=
=C1=D0=B1=ED=A3=BB</div><br><div>&nbsp; &nbsp; &nbsp; &nbsp; 3=A1=
=A2=BB=F1=C8=A1HRegionInfo=A3=AC=BC=B4info=A3=BB</div><br><div>&n=
bsp; &nbsp; &nbsp; &nbsp; 4=A1=A2=B9=B9=D4=ECcompaction=B5=C4=C3=E8=
=CA=F6=D0=C5=CF=A2CompactionDescriptor=A3=BB</div><br><div>&nbsp;=
 &nbsp; &nbsp; &nbsp; 5=A1=A2=C0=FB=D3=C3WALUtil=B9=A4=BE=DF=C0=E0=
=B5=C4writeCompactionMarker()=B7=BD=B7=A8=A3=AC=D4=DAWAL=D6=D0=D0=
=B4=C8=EB=D2=BB=B8=F6=BA=CF=B2=A2=B1=EA=BC=C7=A1=A3</div><br><div=
>&nbsp; &nbsp; &nbsp; &nbsp; =CA=D7=CF=C8=CB=B5=CF=C2=D5=E2=B8=F6=
compaction=B5=C4=C3=E8=CA=F6=D0=C5=CF=A2CompactionDescriptor=A3=AC=
=C6=E4=D6=D0=B0=FC=BA=AC=C1=CB=B1=ED=C3=FBTableName=A1=A2Region=C3=
=FBEncodedRegionName=A1=A2=C1=D0=B4=D8=C3=FBFamilyName=A1=A2=B4=E6=
=B4=A2Home=C2=B7=BE=B6StoreHomeDir=A1=A2=BA=CF=B2=A2=B5=C4=CA=E4=C8=
=EBCompactionInput=A1=A2=BA=CF=B2=A2=B5=C4=CA=E4=B3=F6CompactionO=
utput=B5=C8=B9=D8=BC=FC=D0=C5=CF=A2=A3=AC=CD=EA=D5=FB=B5=C4=C3=E8=
=CA=F6=C1=CB=BA=CF=B2=A2=B5=C4=C8=AB=B2=BF=CF=EA=CF=B8=D0=C5=CF=A2=
=A1=A3=C6=E4=B9=B9=D4=EC=B4=FA=C2=EB=C8=E7=CF=C2=A3=BA</div><br><=
div>public static CompactionDescriptor toCompactionDescriptor(HRe=
gionInfo info, byte[] family,</div><div>&nbsp; &nbsp; &nbsp; List=
&lt;Path&gt; inputPaths, List&lt;Path&gt; outputPaths, Path store=
Dir) {</div><div>&nbsp; &nbsp; // compaction descriptor contains=20=
relative paths.</div><div>&nbsp; &nbsp; // input / output paths a=
re relative to the store dir</div><div>&nbsp; &nbsp; // store dir=
 is relative to region dir</div><div>&nbsp; &nbsp; CompactionDesc=
riptor.Builder builder =3D CompactionDescriptor.newBuilder()</div=
><div>&nbsp; &nbsp; &nbsp; &nbsp; .setTableName(ByteStringer.wrap=
(info.getTableName()))</div><div>&nbsp; &nbsp; &nbsp; &nbsp; .set=
EncodedRegionName(ByteStringer.wrap(info.getEncodedNameAsBytes())=
)</div><div>&nbsp; &nbsp; &nbsp; &nbsp; .setFamilyName(ByteString=
er.wrap(family))</div><div>&nbsp; &nbsp; &nbsp; &nbsp; .setStoreH=
omeDir(storeDir.getName()); //make relative</div><div>&nbsp; &nbs=
p; for (Path inputPath : inputPaths) {</div><div>&nbsp; &nbsp; &n=
bsp; builder.addCompactionInput(inputPath.getName()); //relative=20=
path</div><div>&nbsp; &nbsp; }</div><div>&nbsp; &nbsp; for (Path=20=
outputPath : outputPaths) {</div><div>&nbsp; &nbsp; &nbsp; builde=
r.addCompactionOutput(outputPath.getName());</div><div>&nbsp; &nb=
sp; }</div><div>&nbsp; &nbsp; builder.setRegionName(ByteStringer.=
wrap(info.getRegionName()));</div><div>&nbsp; &nbsp; return build=
er.build();</div><div>&nbsp; }</div><div>&nbsp; &nbsp; &nbsp;&nbs=
p; =D7=EE=BA=F3=A3=AC=C0=FB=D3=C3WALUtil=B9=A4=BE=DF=C0=E0=B5=C4w=
riteCompactionMarker()=B7=BD=B7=A8=A3=AC=D4=DAWAL=D6=D0=D0=B4=C8=EB=
=D2=BB=B8=F6=BA=CF=B2=A2=B1=EA=BC=C7=A3=AC=CE=D2=C3=C7=C0=B4=BF=B4=
=CF=C2=B4=FA=C2=EB=A3=BA</div><div>/**</div><div>&nbsp;&nbsp; * W=
rite the marker that a compaction has succeeded and is about to b=
e committed.</div><div>&nbsp;&nbsp; * This provides info to the H=
Master to allow it to recover the compaction if</div><div>&nbsp;&=
nbsp; * this regionserver dies in the middle (This part is not ye=
t implemented). It also prevents</div><div>&nbsp;&nbsp; * the com=
paction from finishing if this regionserver has already lost its=20=
lease on the log.</div><div>&nbsp;&nbsp; * @param sequenceId Used=
 by WAL to get sequence Id for the waledit.</div><div>&nbsp;&nbsp=
; */</div><div>&nbsp; public static void writeCompactionMarker(WA=
L log, HTableDescriptor htd, HRegionInfo info,</div><div>&nbsp; &=
nbsp; &nbsp; final CompactionDescriptor c, AtomicLong sequenceId)=
 throws IOException {</div><div>&nbsp; &nbsp; </div><div>&nbsp; &=
nbsp; // =B4=D3=BA=CF=B2=A2=D0=C5=CF=A2CompactionDescriptor=D6=D0=
=BB=F1=C8=A1=B1=ED=C3=FBtn</div><div>&nbsp; &nbsp; TableName tn =3D=
 TableName.valueOf(c.getTableName().toByteArray());</div><div>&nb=
sp; &nbsp; </div><div>&nbsp; &nbsp; // we use HLogKey here instea=
d of WALKey directly to support legacy coprocessors.</div><div>&n=
bsp; &nbsp; </div><div>&nbsp; &nbsp; // =B8=F9=BE=DDregion=B5=C4=C3=
=FB=D7=D6=A1=A2=B1=ED=C3=F7tn=A3=AC=B4=B4=BD=A8=D2=BB=B8=F6WALKey=
</div><div>&nbsp; &nbsp; WALKey key =3D new HLogKey(info.getEncod=
edNameAsBytes(), tn);</div><div>&nbsp; &nbsp; </div><div>&nbsp; &=
nbsp; // WAL=D6=D0=CC=ED=BC=D3=D2=BB=CC=F5=BC=C7=C2=BC=A3=AC=B0=FC=
=C0=A8=B1=ED=B5=C4=C3=E8=CA=F6=D0=C5=CF=A2HTableDescriptor=A1=A2W=
ALKey=A1=A2Compaction=D0=C5=CF=A2WALEdit=A1=A2=D0=F2=C1=D0=BA=C5s=
equenceId</div><div>&nbsp; &nbsp; // Compaction=D0=C5=CF=A2WALEdi=
t=CA=C7=B8=F9=BE=DDWALEdit=B5=C4createCompaction()=B7=BD=B7=A8=A3=
=AC=D3=C9HRegionInfo=A1=A2CompactionDescriptor=BB=F1=C8=A1=B5=C4<=
/div><div>&nbsp; &nbsp; // </div><div>&nbsp; &nbsp; log.append(ht=
d, info, key, WALEdit.createCompaction(info, c), sequenceId, fals=
e, null);</div><div>&nbsp; &nbsp; </div><div>&nbsp; &nbsp; // =CD=
=AC=B2=BD=C8=D5=D6=BE</div><div>&nbsp; &nbsp; log.sync();</div><d=
iv>&nbsp; &nbsp; if (LOG.isTraceEnabled()) {</div><div>&nbsp; &nb=
sp; &nbsp; LOG.trace("Appended compaction marker " + TextFormat.s=
hortDebugString(c));</div><div>&nbsp; &nbsp; }</div><div>&nbsp; }=
</div><div>&nbsp; &nbsp; &nbsp; &nbsp; =CB=FC=CA=B5=BC=CA=C9=CF=D4=
=DAWAL=D6=D0append=C1=CB=D2=BB=CC=F5=BC=C7=C2=BC=A3=AC=B0=FC=C0=A8=
=B1=ED=B5=C4=C3=E8=CA=F6=D0=C5=CF=A2HTableDescriptor=A1=A2WALKey=A1=
=A2Compaction=D0=C5=CF=A2WALEdit=A1=A2=D0=F2=C1=D0=BA=C5sequenceI=
d=A3=AC=B6=F8Compaction=D0=C5=CF=A2WALEdit=CA=C7=B8=F9=BE=DDWALEd=
it=B5=C4createCompaction()=B7=BD=B7=A8=A3=AC=D3=C9HRegionInfo=A1=A2=
CompactionDescriptor=B9=B9=D4=EC=B5=C4=A1=A3=B4=FA=C2=EB=C8=E7=CF=
=C2=A3=BA</div><div>/**</div><div>&nbsp;&nbsp; * Create a compaci=
on WALEdit</div><div>&nbsp;&nbsp; * @param c</div><div>&nbsp;&nbs=
p; * @return A WALEdit that has &lt;code&gt;c&lt;/code&gt; serial=
ized as its value</div><div>&nbsp;&nbsp; */</div><div>&nbsp; publ=
ic static WALEdit createCompaction(final HRegionInfo hri, final C=
ompactionDescriptor c) {</div><div>&nbsp; &nbsp; </div><div>&nbsp=
; &nbsp; // =BD=ABCompactionDescriptor=D7=AA=BB=AF=B3=C9byte []</=
div><div>&nbsp; &nbsp; byte [] pbbytes =3D c.toByteArray();</div>=
<div>&nbsp; &nbsp; </div><div>&nbsp; &nbsp; // =B9=B9=D4=ECKeyVal=
ue=A3=AC=B0=FC=C0=A8Region=B5=C4startKey=A1=A2=A1=B0METAFAMILY=A1=
=B1=D7=D6=B7=FB=B4=AE=A1=A2</div><div>&nbsp; &nbsp; // "HBASE::CO=
MPACTION"=D7=D6=B7=FB=B4=AE=A1=A2=B5=B1=C7=B0=CA=B1=BC=E4=BA=CD=BA=
=CF=B2=A2=C3=E8=CA=F6CompactionDescriptor=B5=C4=B6=FE=BD=F8=D6=C6=
=D0=CE=CA=BD</div><div>&nbsp; &nbsp; KeyValue kv =3D new KeyValue=
(getRowForRegion(hri), METAFAMILY, COMPACTION,</div><div>&nbsp; &=
nbsp; &nbsp; EnvironmentEdgeManager.currentTime(), pbbytes);</div=
><div>&nbsp; &nbsp; </div><div>&nbsp; &nbsp; // =BD=ABKeyValue=CC=
=ED=BC=D3=D6=C1WALEdit=A3=AC=B2=A2=B7=B5=BB=D8WALEdit=CA=B5=C0=FD=
</div><div>&nbsp; &nbsp; return new WALEdit().add(kv); //replicat=
ion scope null so that this won't be replicated</div><div>&nbsp;=20=
}</div><div>&nbsp; &nbsp; &nbsp; &nbsp; =B4=FA=C2=EB=D7=A2=CA=CD=B1=
=C8=BD=CF=CF=EA=CF=B8=A3=AC=B2=BB=D4=D9=D7=B8=CA=F6=A1=A3</div><d=
iv>&nbsp; &nbsp; &nbsp; &nbsp; 3=A1=A2=CC=E6=BB=BBStoreFiles=A3=AC=
=C6=E4=D6=D0=B0=FC=C0=A8=C1=C1=B5=E3=A3=BA</div><br><div>&nbsp; &=
nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; =A3=A81=A3=A9=C8=A5=B3=FD=
=B5=F4=CB=F9=D3=D0=B5=C4=BA=CF=B2=A2=C7=B0=A3=AC=BC=B4=D2=D1=B1=BB=
=BA=CF=B2=A2=B5=C4=CE=C4=BC=FEcompactedFiles=A3=AC=BD=AB=BA=CF=B2=
=A2=BA=F3=B5=C4=CE=C4=BC=FEsfs=BC=D3=C8=EB=B5=BDStoreFileManager=B5=
=C4storefiles=D6=D0=C8=A5=A3=ACstorefiles=CE=AAStore=D6=D0=C4=BF=C7=
=B0=C8=AB=B2=BF=CC=E1=B9=A9=B7=FE=CE=F1=B5=C4=B4=E6=B4=A2=CE=C4=BC=
=FE=C1=D0=B1=ED=A3=BB</div><br><div>&nbsp; &nbsp; &nbsp; &nbsp; &=
nbsp; &nbsp;&nbsp; =A3=A82=A3=A9=D5=FD=D4=DA=BA=CF=B2=A2=B5=C4=CE=
=C4=BC=FE=C1=D0=B1=EDfilesCompacting=D6=D0=C8=A5=B3=FD=B1=BB=BA=CF=
=B2=A2=B5=C4=CE=C4=BC=FEfilesToCompact=A3=BB</div><br><div>&nbsp;=
 &nbsp; &nbsp; &nbsp; =BE=DF=CC=E5=B4=FA=C2=EBreplaceStoreFiles()=
=B7=BD=B7=A8=C8=E7=CF=C2=A3=BA</div><br><div>@VisibleForTesting</=
div><div>&nbsp; void replaceStoreFiles(final Collection&lt;StoreF=
ile&gt; compactedFiles,</div><div>&nbsp; &nbsp; &nbsp; final Coll=
ection&lt;StoreFile&gt; result) throws IOException {</div><div>&n=
bsp; &nbsp; </div><div>&nbsp; &nbsp; // =BC=D3=CB=F8=A3=AC=C9=CF=B6=
=C1=D0=B4=CB=F8ReentrantReadWriteLock=B5=C4=D0=B4=CB=F8=A3=AC=D2=E2=
=CE=B6=D7=C5=D5=E2=CA=C7=D2=BB=B0=D1=BB=A5=B3=E2=CB=F8</div><div>=
&nbsp; &nbsp; this.lock.writeLock().lock();</div><div>&nbsp; &nbs=
p; try {</div><div>&nbsp; &nbsp; &nbsp; // =CD=A8=B9=FDStoreFileM=
anager=B5=C4addCompactionResults()=B7=BD=B7=A8=A3=AC=BD=AB=B1=BB=BA=
=CF=B2=A2=B5=C4=CE=C4=BC=FE</div><div>&nbsp; &nbsp; &nbsp; // =C8=
=A5=B3=FD=B5=F4=CB=F9=D3=D0=B5=C4=BA=CF=B2=A2=C7=B0=A3=AC=BC=B4=D2=
=D1=B1=BB=BA=CF=B2=A2=B5=C4=CE=C4=BC=FEcompactedFiles</div><div>&=
nbsp; &nbsp; &nbsp; // =BD=AB=BA=CF=B2=A2=BA=F3=B5=C4=CE=C4=BC=FE=
=BC=D3=C8=EB=B5=BDStoreFileManager=B5=C4storefiles=D6=D0=C8=A5=A3=
=ACstorefiles=CE=AAStore=D6=D0=C4=BF=C7=B0=C8=AB=B2=BF=CC=E1=B9=A9=
=B7=FE=CE=F1=B5=C4=B4=E6=B4=A2=CE=C4=BC=FE=C1=D0=B1=ED</div><div>=
&nbsp; &nbsp; &nbsp; this.storeEngine.getStoreFileManager().addCo=
mpactionResults(compactedFiles, result);</div><div>&nbsp; &nbsp;=20=
&nbsp; </div><div>&nbsp; &nbsp; &nbsp; // =D5=FD=D4=DA=BA=CF=B2=A2=
=B5=C4=CE=C4=BC=FE=C1=D0=B1=EDfilesCompacting=D6=D0=C8=A5=B3=FD=B1=
=BB=BA=CF=B2=A2=B5=C4=CE=C4=BC=FE</div><div>&nbsp; &nbsp; &nbsp;=20=
filesCompacting.removeAll(compactedFiles); // safe bc: lock.write=
Lock();</div><div>&nbsp; &nbsp; } finally {</div><div>&nbsp; &nbs=
p; &nbsp; // =BD=E2=CB=F8</div><div>&nbsp; &nbsp; &nbsp; this.loc=
k.writeLock().unlock();</div><div>&nbsp; &nbsp; }</div><div>&nbsp=
; }</div><div>&nbsp; &nbsp; &nbsp; &nbsp; 4=A1=A2=CD=EA=B3=C9=BA=CF=
=B2=A2=A3=BA=B9=E9=B5=B5=BE=C9=CE=C4=BC=FE=A3=A8=D4=DA=CE=C4=BC=FE=
=CF=B5=CD=B3=D6=D0=C9=BE=B3=FD=D2=D1=B1=BB=BA=CF=B2=A2=B5=C4=CE=C4=
=BC=FEcompactedFiles=A3=AC=CA=B5=BC=CA=C9=CF=CA=C7=B9=E9=B5=B5=B2=
=D9=D7=F7=A3=AC=BD=AB=BE=C9=B5=C4=CE=C4=BC=FE=B4=D3=D4=AD=CE=BB=D6=
=C3=D2=C6=B5=BD=B9=E9=B5=B5=C4=BF=C2=BC=CF=C2=A3=A9=A3=AC=B9=D8=B1=
=D5=C6=E4=C9=CF=B5=C4Reader=A3=AC=B2=A2=B8=FC=D0=C2store=B4=F3=D0=
=A1=A1=A3completeCompaction()=B4=FA=C2=EB=C8=E7=CF=C2=A3=BA</div>=
<div>&nbsp; /**</div><div>&nbsp;&nbsp; * &lt;p&gt;It works by pro=
cessing a compaction that's been written to disk.</div><div>&nbsp=
;&nbsp; *</div><div>&nbsp;&nbsp; * &lt;p&gt;It is usually invoked=
 at the end of a compaction, but might also be</div><div>&nbsp;&n=
bsp; * invoked at HStore startup, if the prior execution died mid=
way through.</div><div>&nbsp;&nbsp; *</div><div>&nbsp;&nbsp; * &l=
t;p&gt;Moving the compacted TreeMap into place means:</div><div>&=
nbsp;&nbsp; * &lt;pre&gt;</div><div>&nbsp;&nbsp; * 1) Unload all=20=
replaced StoreFile, close and collect list to delete.</div><div>&=
nbsp;&nbsp; * 2) Compute new store size</div><div>&nbsp;&nbsp; *=20=
&lt;/pre&gt;</div><div>&nbsp;&nbsp; *</div><div>&nbsp;&nbsp; * @p=
aram compactedFiles list of files that were compacted</div><div>&=
nbsp;&nbsp; */</div><div>&nbsp; @VisibleForTesting</div><div>&nbs=
p; protected void completeCompaction(final Collection&lt;StoreFil=
e&gt; compactedFiles, boolean removeFiles)</div><div>&nbsp; &nbsp=
; &nbsp; throws IOException {</div><div>&nbsp; &nbsp; try {</div>=
<div>&nbsp; &nbsp; &nbsp; // Do not delete old store files until=20=
we have sent out notification of</div><div>&nbsp; &nbsp; &nbsp; /=
/ change in case old files are still being accessed by outstandin=
g scanners.</div><div>&nbsp; &nbsp; &nbsp; // Don't do this under=
 writeLock; see HBASE-4485 for a possible deadlock</div><div>&nbs=
p; &nbsp; &nbsp; // scenario that could have happened if continue=
 to hold the lock.</div><div>&nbsp; &nbsp; &nbsp; // =CD=A8=D6=AA=
Reader=B9=DB=B2=EC=D5=DF</div><div>&nbsp; &nbsp; &nbsp; notifyCha=
ngedReadersObservers();</div><div>&nbsp; &nbsp; &nbsp; // At this=
 point the store will use new files for all scanners.</div><div>&=
nbsp;</div><div>&nbsp; &nbsp; &nbsp; // let the archive util deci=
de if we should archive or delete the files</div><div>&nbsp; &nbs=
p; &nbsp; LOG.debug("Removing store files after compaction...");<=
/div><div>&nbsp; &nbsp; &nbsp; </div><div>&nbsp; &nbsp; &nbsp; //=
 =B1=E9=C0=FA=D2=D1=B1=BB=BA=CF=B2=A2=B5=C4=CE=C4=BC=FEcompleteCo=
mpaction=A3=AC=B9=D8=B1=D5=C6=E4=C9=CF=B5=C4Reader</div><div>&nbs=
p; &nbsp; &nbsp; for (StoreFile compactedFile : compactedFiles) {=
</div><div>&nbsp; &nbsp; &nbsp; &nbsp; compactedFile.closeReader(=
true);</div><div>&nbsp; &nbsp; &nbsp; }</div><div>&nbsp; &nbsp; &=
nbsp; </div><div>&nbsp; &nbsp; &nbsp; // =D4=DA=CE=C4=BC=FE=CF=B5=
=CD=B3=D6=D0=C9=BE=B3=FD=D2=D1=B1=BB=BA=CF=B2=A2=B5=C4=CE=C4=BC=FE=
compactedFiles=A3=AC=CA=B5=BC=CA=C9=CF=CA=C7=B9=E9=B5=B5=B2=D9=D7=
=F7=A3=AC=BD=AB=BE=C9=B5=C4=CE=C4=BC=FE=B4=D3=D4=AD=CE=BB=D6=C3=D2=
=C6=B5=BD=B9=E9=B5=B5=C4=BF=C2=BC=CF=C2</div><div>&nbsp; &nbsp; &=
nbsp; if (removeFiles) {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; th=
is.fs.removeStoreFiles(this.getColumnFamilyName(), compactedFiles=
);</div><div>&nbsp; &nbsp; &nbsp; }</div><div>&nbsp; &nbsp; } cat=
ch (IOException e) {</div><div>&nbsp; &nbsp; &nbsp; e =3D RemoteE=
xceptionHandler.checkIOException(e);</div><div>&nbsp; &nbsp; &nbs=
p; LOG.error("Failed removing compacted files in " + this +</div>=
<div>&nbsp; &nbsp; &nbsp; &nbsp; ". Files we were trying to remov=
e are " + compactedFiles.toString() +</div><div>&nbsp; &nbsp; &nb=
sp; &nbsp; "; some of them may have been already removed", e);</d=
iv><div>&nbsp; &nbsp; }</div><div>&nbsp;</div><div>&nbsp; &nbsp;=20=
// 4. Compute new store size</div><div>&nbsp; &nbsp; // =BC=C6=CB=
=E3=D0=C2=B5=C4store=B4=F3=D0=A1</div><div>&nbsp; &nbsp; this.sto=
reSize =3D 0L;</div><div>&nbsp; &nbsp; this.totalUncompressedByte=
s =3D 0L;</div><div>&nbsp; &nbsp; </div><div>&nbsp; &nbsp; // =B1=
=E9=C0=FAStoreFiles=A3=AC=BC=C6=CB=E3storeSize=A1=A2totalUncompre=
ssedBytes=B5=C8=B4=F3=D0=A1</div><div>&nbsp; &nbsp; for (StoreFil=
e hsf : this.storeEngine.getStoreFileManager().getStorefiles()) {=
</div><div>&nbsp; &nbsp; &nbsp; StoreFile.Reader r =3D hsf.getRea=
der();</div><div>&nbsp; &nbsp; &nbsp; if (r =3D=3D null) {</div><=
div>&nbsp; &nbsp; &nbsp; &nbsp; LOG.warn("StoreFile " + hsf + " h=
as a null Reader");</div><div>&nbsp; &nbsp; &nbsp; &nbsp; continu=
e;</div><div>&nbsp; &nbsp; &nbsp; }</div><div>&nbsp; &nbsp; &nbsp=
; this.storeSize +=3D r.length();</div><div>&nbsp; &nbsp; &nbsp;=20=
this.totalUncompressedBytes +=3D r.getTotalUncompressedBytes();</=
div><div>&nbsp; &nbsp; }</div><div>&nbsp; }</div><div>&nbsp; &nbs=
p; &nbsp; &nbsp; =C6=E4=CB=FB=B4=FA=C2=EB=D7=A2=CA=CD=D6=D0=B6=BC=
=D3=D0=A3=AC=D5=E2=C0=EF=A3=AC=CE=D2=C3=C7=D2=AA=B5=A5=B6=C0=CB=B5=
=CF=C2HRegionFileSystem=B5=C4removeStoreFiles()=B7=BD=B7=A8=A3=AC=
=C8=E7=CF=C2=A3=BA</div><div>/**</div><div>&nbsp;&nbsp; * Closes=20=
and archives the specified store files from the specified family.=
</div><div>&nbsp;&nbsp; * @param familyName Family that contains=20=
the store files</div><div>&nbsp;&nbsp; * @param storeFiles set of=
 store files to remove</div><div>&nbsp;&nbsp; * @throws IOExcepti=
on if the archiving fails</div><div>&nbsp;&nbsp; */</div><div>&nb=
sp; public void removeStoreFiles(final String familyName, final C=
ollection&lt;StoreFile&gt; storeFiles)</div><div>&nbsp; &nbsp; &n=
bsp; throws IOException {</div><div>&nbsp; &nbsp; HFileArchiver.a=
rchiveStoreFiles(this.conf, this.fs, this.regionInfoForFs,</div><=
div>&nbsp; &nbsp; &nbsp; &nbsp; this.tableDir, Bytes.toBytes(fami=
lyName), storeFiles);</div><div>&nbsp; }</div><div>&nbsp; &nbsp;=20=
&nbsp; &nbsp; =CB=FC=D7=EE=D6=D5=CA=C7=CD=A8=B9=FDHFileArchiver=B5=
=C4archiveStoreFiles()=B7=BD=B7=A8=C0=B4=CD=EA=B3=C9=B5=C4=A3=AC=B4=
=FA=C2=EB=C8=E7=CF=C2=A3=BA</div><div>/**</div><div>&nbsp;&nbsp;=20=
* Remove the store files, either by archiving them or outright de=
letion</div><div>&nbsp;&nbsp; * @param conf {@link Configuration}=
 to examine to determine the archive directory</div><div>&nbsp;&n=
bsp; * @param fs the filesystem where the store files live</div><=
div>&nbsp;&nbsp; * @param regionInfo {@link HRegionInfo} of the r=
egion hosting the store files</div><div>&nbsp;&nbsp; * @param fam=
ily the family hosting the store files</div><div>&nbsp;&nbsp; * @=
param compactedFiles files to be disposed of. No further reading=20=
of these files should be</div><div>&nbsp;&nbsp; *&nbsp; &nbsp; &n=
bsp; &nbsp; &nbsp; attempted; otherwise likely to cause an {@link=
 IOException}</div><div>&nbsp;&nbsp; * @throws IOException if the=
 files could not be correctly disposed.</div><div>&nbsp;&nbsp; */=
</div><div>&nbsp; public static void archiveStoreFiles(Configurat=
ion conf, FileSystem fs, HRegionInfo regionInfo,</div><div>&nbsp;=
 &nbsp; &nbsp; Path tableDir, byte[] family, Collection&lt;StoreF=
ile&gt; compactedFiles) throws IOException {</div><div>&nbsp;</di=
v><div>&nbsp; &nbsp; // sometimes in testing, we don't have rss,=20=
so we need to check for that</div><div>&nbsp; &nbsp; if (fs =3D=3D=
 null) {</div><div>&nbsp; &nbsp; &nbsp; LOG.warn("Passed filesyst=
em is null, so just deleting the files without archiving for regi=
on:"</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + Bytes.toStrin=
g(regionInfo.getRegionName()) + ", family:" + Bytes.toString(fami=
ly));</div><div>&nbsp; &nbsp; &nbsp; deleteStoreFilesWithoutArchi=
ving(compactedFiles);</div><div>&nbsp; &nbsp; &nbsp; return;</div=
><div>&nbsp; &nbsp; }</div><div>&nbsp;</div><div>&nbsp; &nbsp; //=
 short circuit if we don't have any files to delete</div><div>&nb=
sp; &nbsp; // =C5=D0=B6=CF=B1=BB=BA=CF=B2=A2=CE=C4=BC=FE=C1=D0=B1=
=EDcompactedFiles=B5=C4=B4=F3=D0=A1=A3=AC=C8=E7=B9=FB=CE=AA0=A3=AC=
=C1=A2=BC=B4=B7=B5=BB=D8</div><div>&nbsp; &nbsp; if (compactedFil=
es.size() =3D=3D 0) {</div><div>&nbsp; &nbsp; &nbsp; LOG.debug("N=
o store files to dispose, done!");</div><div>&nbsp; &nbsp; &nbsp;=
 return;</div><div>&nbsp; &nbsp; }</div><div>&nbsp;</div><div>&nb=
sp; &nbsp; // build the archive path</div><div>&nbsp; &nbsp; if (=
regionInfo =3D=3D null || family =3D=3D null) throw new IOExcepti=
on(</div><div>&nbsp; &nbsp; &nbsp; &nbsp; "Need to have a region=20=
and a family to archive from.");</div><div>&nbsp;</div><div>&nbsp=
; &nbsp; // =BB=F1=C8=A1=B9=E9=B5=B5=B4=E6=B4=A2=C2=B7=BE=B6</div=
><div>&nbsp; &nbsp; Path storeArchiveDir =3D HFileArchiveUtil.get=
StoreArchivePath(conf, regionInfo, tableDir, family);</div><div>&=
nbsp;</div><div>&nbsp; &nbsp; // make sure we don't archive if we=
 can't and that the archive dir exists</div><div>&nbsp; &nbsp; //=
 =B4=B4=BD=A8=C2=B7=BE=B6</div><div>&nbsp; &nbsp; if (!fs.mkdirs(=
storeArchiveDir)) {</div><div>&nbsp; &nbsp; &nbsp; throw new IOEx=
ception("Could not make archive directory (" + storeArchiveDir +=20=
") for store:"</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + Byt=
es.toString(family) + ", deleting compacted files instead.");</di=
v><div>&nbsp; &nbsp; }</div><div>&nbsp;</div><div>&nbsp; &nbsp; /=
/ otherwise we attempt to archive the store files</div><div>&nbsp=
; &nbsp; if (LOG.isDebugEnabled()) LOG.debug("Archiving compacted=
 store files.");</div><div>&nbsp;</div><div>&nbsp; &nbsp; // Wrap=
 the storefile into a File</div><div>&nbsp; &nbsp; StoreToFile ge=
tStorePath =3D new StoreToFile(fs);</div><div>&nbsp; &nbsp; Colle=
ction&lt;File&gt; storeFiles =3D Collections2.transform(compacted=
Files, getStorePath);</div><div>&nbsp;</div><div>&nbsp; &nbsp; //=
 do the actual archive</div><div>&nbsp; &nbsp; // =CD=A8=B9=FDres=
olveAndArchive()=D6=B4=D0=D0=B9=E9=B5=B5</div><div>&nbsp; &nbsp;=20=
if (!resolveAndArchive(fs, storeArchiveDir, storeFiles)) {</div><=
div>&nbsp; &nbsp; &nbsp; throw new IOException("Failed to archive=
/delete all the files for region:"</div><div>&nbsp; &nbsp; &nbsp;=
 &nbsp; &nbsp; + Bytes.toString(regionInfo.getRegionName()) + ",=20=
family:" + Bytes.toString(family)</div><div>&nbsp; &nbsp; &nbsp;=20=
&nbsp; &nbsp; + " into " + storeArchiveDir + ". Something is prob=
ably awry on the filesystem.");</div><div>&nbsp; &nbsp; }</div><d=
iv>&nbsp; }</div><div>&nbsp; &nbsp; &nbsp; &nbsp; =B2=E3=B2=E3=B5=
=F7=D3=C3=B0=A1=A3=AC=BD=D3=D7=C5=C0=B4=B0=C9=A3=AC=BC=CC=D0=F8=BF=
=B4=B9=D8=BC=FC=B4=FA=C2=EB=A3=BA</div><div>// =C8=E7=B9=FB=CA=C7=
=CE=C4=BC=FE</div><div>&nbsp; &nbsp; &nbsp; &nbsp; if (file.isFil=
e()) {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // attempt to=
 archive the file</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if=
 (!resolveAndArchiveFile(baseArchiveDir, file, startTime)) {</div=
><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LOG.warn("Couldn'=
t archive " + file + " into backup directory: " + baseArchiveDir)=
;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; failures.ad=
d(file);</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</div><div=
>&nbsp; &nbsp; &nbsp; &nbsp; }</div><div>&nbsp; &nbsp; &nbsp; &nb=
sp; =B6=F8=D5=E2=B8=F6resolveAndArchiveFile()=B7=BD=B7=A8=B2=BB=CA=
=C7=BC=F2=B5=A5=B5=C4=C9=BE=B3=FD=CE=C4=BC=FE=A3=AC=B6=F8=CA=C7=CD=
=A8=B9=FDrename()=B7=BD=B7=A8=BD=AB=BE=C9=B5=C4=B4=E6=B4=A2=CE=C4=
=BC=FE=C5=B2=D6=C1=C1=CB=B9=E9=B5=B5=C2=B7=BE=B6=CF=C2=A3=AC=B4=FA=
=C2=EB=C8=E7=CF=C2=A3=BA</div><div>// move the archive file to th=
e stamped backup</div><div>&nbsp; &nbsp; &nbsp; Path backedupArch=
iveFile =3D new Path(archiveDir, filename + SEPARATOR + archiveSt=
artTime);</div><div>&nbsp; &nbsp; &nbsp; if (!fs.rename(archiveFi=
le, backedupArchiveFile)) {</div><div>&nbsp; &nbsp; &nbsp; &nbsp;=
 LOG.error("Could not rename archive file to backup: " + backedup=
ArchiveFile</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +=
 ", deleting existing file in favor of newer.");</div><div>&nbsp;=
 &nbsp; &nbsp; &nbsp; // try to delete the exisiting file, if we=20=
can't rename it</div><div>&nbsp; &nbsp; &nbsp; &nbsp; if (!fs.del=
ete(archiveFile, false)) {</div><div>&nbsp; &nbsp; &nbsp; &nbsp;=20=
&nbsp; throw new IOException("Couldn't delete existing archive fi=
le (" + archiveFile</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=20=
&nbsp; &nbsp; + ") or rename it to the backup file (" + backedupA=
rchiveFile</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &n=
bsp; + ") to make room for similarly named file.");</div><div>&nb=
sp; &nbsp; &nbsp; &nbsp; }</div><div>&nbsp; &nbsp; &nbsp; }</div>=
<div>&nbsp; &nbsp; &nbsp; &nbsp; 5=A1=A2=CD=EA=B3=C9Compaction=C7=
=EB=C7=F3=A3=BARegion=BB=E3=B1=A8=BA=CF=B2=A2=C7=EB=C7=F3=D6=C1=D6=
=D5=B6=CB=A1=A2filesCompacting=D6=D0=C9=BE=B3=FD=C7=EB=C7=F3=D6=D0=
=B5=C4=CB=F9=D3=D0=B4=FD=BA=CF=B2=A2=CE=C4=BC=FE</div><div>&nbsp;=
 &nbsp; &nbsp; &nbsp; =D5=E2=B2=BF=B7=D6=CA=C7=D3=C9=B7=BD=B7=A8f=
inishCompactionRequest()=CD=EA=B3=C9=B5=C4=A3=AC=B4=FA=C2=EB=C8=E7=
=CF=C2=A3=BA</div><br></div><div>private void finishCompactionReq=
uest(CompactionRequest cr) {</div><div>&nbsp; &nbsp; // Region=BB=
=E3=B1=A8=BA=CF=B2=A2=C7=EB=C7=F3=D6=C1=D6=D5=B6=CB</div><div>&nb=
sp; &nbsp; this.region.reportCompactionRequestEnd(cr.isMajor(), c=
r.getFiles().size(), cr.getSize());</div><div>&nbsp; &nbsp; </div=
><div>&nbsp; &nbsp; // </div><div>&nbsp; &nbsp; if (cr.isOffPeak(=
)) {</div><div>&nbsp; &nbsp; &nbsp; offPeakCompactionTracker.set(=
false);</div><div>&nbsp; &nbsp; &nbsp; cr.setOffPeak(false);</div=
><div>&nbsp; &nbsp; }</div><div>&nbsp; &nbsp; </div><div>&nbsp; &=
nbsp; // filesCompacting=D6=D0=C9=BE=B3=FD=C7=EB=C7=F3=D6=D0=B5=C4=
=CB=F9=D3=D0=B4=FD=BA=CF=B2=A2=CE=C4=BC=FE</div><div>&nbsp; &nbsp=
; synchronized (filesCompacting) {</div><div>&nbsp; &nbsp; &nbsp;=
 filesCompacting.removeAll(cr.getFiles());</div><div>&nbsp; &nbsp=
; }</div><div>&nbsp; }</div><div>&nbsp; &nbsp; &nbsp; &nbsp; =B6=C1=
=D5=DF=BF=C9=D7=D4=D0=D0=B7=D6=CE=F6=A3=AC=B2=BB=D4=D9=D7=B8=CA=F6=
=A1=A3</div><div>&nbsp; &nbsp; &nbsp; &nbsp; =BA=C3=C1=CB=A3=AC=BE=
=CD=CF=C8=B5=BD=D5=E2=C0=EF=B0=C9=A3=AC=C7=D2=B4=FD=CF=C2=BB=D8=B7=
=D6=BD=E2=A3=A1</div><div>=A1=AA=A1=AA=A1=AA=A1=AA=A1=AA=A1=AA=A1=
=AA=A1=AA=A1=AA=A1=AA=A1=AA=A1=AA=A1=AA=A1=AA=A1=AA=A1=AA</div><d=
iv>=B0=E6=C8=A8=C9=F9=C3=F7=A3=BA=B1=BE=CE=C4=CE=AACSDN=B2=A9=D6=F7=
=A1=B8lipeng_bigdata=A1=B9=B5=C4=D4=AD=B4=B4=CE=C4=D5=C2=A3=AC=D7=
=F1=D1=ADCC 4.0 BY-SA=B0=E6=C8=A8=D0=AD=D2=E9=A3=AC=D7=AA=D4=D8=C7=
=EB=B8=BD=C9=CF=D4=AD=CE=C4=B3=F6=B4=A6=C1=B4=BD=D3=BC=B0=B1=BE=C9=
=F9=C3=F7=A1=A3</div><div>=D4=AD=CE=C4=C1=B4=BD=D3=A3=BAhttps://b=
log.csdn.net/lipeng_bigdata/article/details/50791205</div><div><b=
r></div></body></html>

------=_Next_Part_0000349875.905--

------=_Next_Part_0001049625.832--

